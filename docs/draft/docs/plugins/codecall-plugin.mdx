---
title: CodeCall Plugin
slug: plugins/codecall-plugin
description: Hide huge tool inventories behind a code-first meta API with searchable discovery, schema inspection, and sandboxed execution plans.
icon: code
---

The CodeCall plugin collapses sprawling tool catalogs into four meta-tools that models understand. Instead of flooding `list_tools` with every CRUD endpoint, CodeCall lets the model search for what it needs, inspect schemas, and run a JavaScript plan that orchestrates multiple tools through Enclave's secure runtime.

CodeCall keeps your existing safety pipeline intact: every real tool call still flows through your normal plugins, observability hooks, and auth layers. The only difference is that orchestration lives inside an AgentScript plan instead of the model's prompt window.

## Why CodeCall?

<CardGroup cols={2}>
  <Card title="Scale beyond context limits" icon="arrows-maximize">
    Replace hundreds of raw tools in <code>list_tools</code> with a lightweight discovery API that the model can query on demand.
  </Card>
  <Card title="Semantic tool discovery" icon="magnifying-glass">
    Built-in TF-IDF indexing works anywhere, and you can flip to VectoriaDB embeddings (with optional HNSW) for high-recall semantic search.
  </Card>
  <Card title="Cross-app orchestration" icon="layer-group">
    Search, describe, and execute tools across every FrontMCP app while keeping per-app policies intact.
  </Card>
  <Card title="Defense-in-depth execution" icon="shield-check">
    Enclave plus ast-guard validate every plan, strip dangerous globals, enforce timeouts, and optionally stream logs back to the client.
  </Card>
</CardGroup>

## Meta-tools at a glance

| Meta-tool                    | What it does                                                                                                          | When to use                                                                    |
| ---------------------------- | --------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------ |
| `codecall.search`            | Natural-language query over all tools, returning ranked matches with scores, app IDs, and descriptions.               | First step for the model to discover relevant tools.                           |
| `codecall.describe`          | Fetches input and output schemas (with examples) for up to `maxDefinitions` tools.                                    | Before writing a plan so the model knows exact parameters.                     |
| `codecall.execute`           | Runs AgentScript inside Enclave, exposing `callTool`, `getTool`, `codecallContext`, `mcpLog`, and optional `console`. | Multi-step workflows, joins, fan-out and fan-in, conditional logic.            |
| `codecall.invoke` (optional) | Directly calls a single tool without going through the VM.                                                            | Simple CRUD calls when you still want search and describe but not custom code. |

## Quick start

```ts
import { App, Tool, ToolContext } from '@frontmcp/sdk';
import { z } from 'zod';
import CodeCallPlugin from '@frontmcp/plugins/codecall';

@Tool({
  name: 'crm.users:list',
  description: 'List CRM users with optional status filtering.',
  inputSchema: {
    status: z.enum(['active', 'inactive', 'pending']).optional(),
  },
  codecall: {
    enabledInCodeCall: true,
    visibleInListTools: false,
  },
})
class UsersListTool extends ToolContext {
  async execute(input: { status?: 'active' | 'inactive' | 'pending' }) {
    return this.db.listUsers(input.status);
  }
}

@App({
  id: 'crm',
  name: 'CRM Demo',
  tools: [UsersListTool],
  plugins: [
    CodeCallPlugin.init({
      mode: 'codecall_only',
      topK: 8,
      maxDefinitions: 6,
      embedding: {
        strategy: 'ml',
        modelName: 'Xenova/all-MiniLM-L6-v2',
        cacheDir: './.cache/transformers',
        useHNSW: true,
      },
      vm: {
        preset: 'secure',
        timeoutMs: 4000,
        allowConsole: true,
      },
      sidecar: {
        enabled: true,
        extractionThreshold: 4096,
        maxReferenceSize: 1024 * 1024,
      },
      directCalls: {
        enabled: true,
        allowedTools: ['crm.users:list'],
      },
    }),
  ],
})
export default class CrmApp {}
```

<Note>
  `list_tools` now only exposes the CodeCall meta-tools (plus any tools you explicitly keep visible). The model must call
  `codecall.search` -> `codecall.describe` -> `codecall.execute` or `codecall.invoke`, which keeps the tool surface area manageable.
</Note>

## Tool search and embeddings

CodeCall indexes every tool in your scope through the `ToolSearchService`. Two strategies are available:

- **TF-IDF (`strategy: 'tfidf'`)**: default mode. No model downloads, reindexes synchronously, great for CI or air-gapped environments.
- **VectoriaDB (`strategy: 'ml'`)**: uses VectoriaDB plus transformers.js for semantic search, optional HNSW acceleration, and metadata filters.

```ts
CodeCallPlugin.init({
  embedding: {
    strategy: 'ml',            // switch to 'tfidf' for zero dependencies
    modelName: 'Xenova/all-MiniLM-L6-v2',
    cacheDir: './.cache/transformers',
    useHNSW: true,             // enable approximate nearest neighbor search
  },
});
```

<Tip>
  When using ML embeddings, store the `cacheDir` on a writable path so the 22 MB model only downloads once. TF-IDF mode stores its index entirely in memory and needs no setup.
</Tip>

## Configuration reference

### Modes

- `codecall_only` (default): hide every tool from `list_tools`, but allow them via CodeCall unless a tool opts out.
- `codecall_opt_in`: hide everything and require each tool to set `codecall.enabledInCodeCall: true`.
- `metadata_driven`: do nothing automatically. You decide per tool whether it shows up anywhere.

<Info>
  Regardless of mode, you can always keep a handful of escape-hatch tools visible by setting `visibleInListTools: true`.
</Info>

### Search responses

- `topK`: maximum matches returned by `codecall.search`.
- `maxDefinitions`: cap for `codecall.describe`. Models rarely need more than 5 to 8 schemas at once, and small numbers keep responses fast.

### Direct calls (`codecall.invoke`)

Enable `directCalls.enabled` when you want to skip the VM for simple single-tool scenarios. You can:

- Provide `allowedTools` (array of names such as `crm.users:create`).
- Provide a `filter` function that receives `{ name, appId, source, tags }`.
- Leave `enabled` false if you want every workflow to go through `codecall.execute`.

### VM execution presets (`vm`)

The `vm` section configures Enclave. Pick a preset, then override anything:

| Preset             | Loops | Console | Timeout (ms) | Use when                                   |
| ------------------ | ----- | ------- | ------------ | ------------------------------------------ |
| `locked_down`      | No    | No      | 2000         | Strictest mode for untrusted tenants.      |
| `secure` (default) | No    | Yes     | 3500         | Balanced security versus capability.       |
| `balanced`         | Yes   | Yes     | 5000         | Allow loops and console for complex plans. |
| `experimental`     | Yes   | Yes     | 10000        | Generous sandbox for internal testing.     |

All presets block `eval`, `Function`, `AsyncFunction`, `require`, `process`, `fetch`, and timer globals. Override `allowLoops`, `timeoutMs`, `maxSteps`, `disabledBuiltins`, or `disabledGlobals` per your threat model.

### Sidecar for large data (`sidecar`)

Sidecar mode stores large strings outside the script and injects reference tokens. Configure:

- `enabled`: toggle the feature.
- `maxTotalSize`, `maxReferenceSize`, `maxResolvedSize`: guardrails against DoS.
- `extractionThreshold`: strings larger than this move to the sidecar automatically.
- `allowComposites`: set to `false` (default) to forbid concatenating reference tokens.
- `maxScriptLengthWhenDisabled`: hard cap on script length when sidecar is off; exceeding it throws `ScriptTooLargeError`.

### Embedding configuration (`embedding`)

- `strategy`: `'tfidf'` or `'ml'`.
- `modelName`: any transformers.js compatible model (only when `strategy === 'ml'`).
- `cacheDir`: download location for ML models.
- `useHNSW`: enable approximate nearest neighbor search for large indexes.

## Tool metadata

Assign CodeCall-specific flags per tool:

```ts
@Tool({
  name: 'crm.activities:list',
  description: 'List user activity with filters.',
  codecall: {
    enabledInCodeCall: true,
    visibleInListTools: false,
    appId: 'crm',          // optional hint to bias search scores
    tags: ['crm', 'activities'],
  },
})
export class ActivitiesListTool extends ToolContext {}
```

<Info>
  Metadata lives under `metadata.codecall`. You can set the same fields when using the functional `tool()` helper.
</Info>

## AgentScript runtime and safety

- **ast-guard preset**: every plan is parsed and validated before execution. Blocked constructs return a structured `ValidationError`.
- **Enclave sandbox**: `callTool`, `getTool`, `codecallContext`, `mcpLog`, `mcpNotify`, and (optionally) a limited `console` are the only globals.
- **Context injection**: pass a `context` object to `codecall.execute` to expose read-only data via `codecallContext`.
- **Logs and telemetry**: `mcpLog` and `console` output are captured and returned with the execution result so you can display them in your UI.
- **Tool isolation**: real tool calls still flow through your pipeline. CodeCall cannot bypass auth, PII scrubbing, or rate limits.
- **Script size guard**: when sidecar is disabled, scripts longer than `maxScriptLengthWhenDisabled` throw `ScriptTooLargeError`.

<Warning>
  If you see `VALIDATION_ERROR` in the execution result, the AST guard rejected the plan. Surface the error message back to the model; it is designed to be human readable.
</Warning>

## CRM demo

`apps/demo/src/apps/crm` ships a fully wired `CrmMcpApp` that registers nine tools, the CodeCall plugin, and an in-memory `CrmStore`. It showcases user CRUD, activity logging, and stats aggregation through CodeCall.

1. Import and register the app in your demo server:

```ts
import CrmMcpApp from './apps/crm';

@FrontMcp({
  apps: [ExpenseMcpApp, CalculatorMcpApp, EmployeeTimeMcpApp, CrmMcpApp],
  // ...
})
export default class Server {}
```

2. Start the demo server:

```bash
yarn nx serve demo
```

3. Connect with the MCP Inspector and call `codecall.search` (for example, "add a pending user and log their login").

### Available tools

**Users**

| Tool           | Description                                                            |
| -------------- | ---------------------------------------------------------------------- |
| `users:list`   | Filter users by status or role.                                        |
| `users:get`    | Fetch by ID or email.                                                  |
| `users:create` | Create a user with optional role and status. Rejects duplicate emails. |
| `users:update` | Update email, name, role, or status with collision checks.             |
| `users:delete` | Remove a user and emit a success message.                              |

**Activities**

| Tool               | Description                                                    |
| ------------------ | -------------------------------------------------------------- |
| `activities:list`  | Filter by user ID, type, and limit with newest-first ordering. |
| `activities:log`   | Append a structured event and update `lastLoginAt` on login.   |
| `activities:stats` | Return totals plus counts per activity type.                   |

<Tip>
  The store lives in `apps/demo/src/apps/crm/data/store.ts`. Swap it for your own persistence layer to prototype enterprise CRM flows without touching the plugin.
</Tip>

## Troubleshooting

- **"No tools found"**: make sure `codecall.enabledInCodeCall` is `true` and that your query matches descriptions or tags. Switch to `embedding.strategy: 'ml'` for fuzzier matches.
- **`ScriptTooLargeError`**: enable the sidecar or reduce inline data. This often happens when a model pastes huge JSON blobs into the plan.
- **Tool execution fails silently**: real tool errors are bubbled up through the Enclave result. Check `error.toolName` in the response.
- **`codecall.invoke` not listed**: you left `directCalls.enabled` as `false`, or the tool is not on the `allowedTools` list.

## Links and resources

<CardGroup cols={2}>
  <Card title="CRM CodeCall demo" icon="code" href="https://github.com/agentfront/frontmcp/tree/main/apps/demo/src/apps/crm">
    Explore the full sample with CrmStore, user and activity tools, and plugin registration.
  </Card>
  <Card title="VectoriaDB guide" icon="magnifying-glass" href="/docs/guides/vectoriadb">
    Learn how the embedding and TF-IDF indexes powering CodeCall search work.
  </Card>
  <Card title="AST Guard guide" icon="shield-check" href="/docs/guides/ast-guard">
    Understand the validation rules applied to every AgentScript plan.
  </Card>
  <Card title="Enclave guide" icon="shield-halved" href="/docs/guides/enclave">
    Deep dive into the sandbox that CodeCall uses for execution.
  </Card>
</CardGroup>
