name: PR Testing Registry

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to test (e.g., 123)"
        required: true
        type: string
      timeout_hours:
        description: "How long to keep registry running (max 6 hours)"
        required: false
        type: choice
        options:
          - "1"
          - "2"
          - "3"
          - "4"
          - "5"
          - "6"
        default: "2"
      ngrok_domain:
        description: "Custom ngrok domain (optional, e.g., my-domain.ngrok.io)"
        required: false
        type: string
        default: ""

permissions:
  contents: read
  pull-requests: write

# Max 6 hours runtime
jobs:
  start-registry:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      NX_DAEMON: "false"

    steps:
      - name: Validate PR number
        run: |
          if ! [[ "${{ inputs.pr_number }}" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid PR number: ${{ inputs.pr_number }}"
            exit 1
          fi

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/pull/${{ inputs.pr_number }}/head

      - name: Get PR info
        id: pr-info
        run: |
          SHA=$(git rev-parse --short HEAD)
          FULL_SHA=$(git rev-parse HEAD)
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "full_sha=$FULL_SHA" >> "$GITHUB_OUTPUT"
          echo "PR SHA: $SHA"

      - name: Get Node version
        id: node-version
        run: echo "version=$(cat .nvmrc)" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.node-version.outputs.version }}
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Create Verdaccio config
        run: |
          mkdir -p /tmp/verdaccio-pr
          cat > /tmp/verdaccio-pr/config.yaml << 'EOF'
          storage: /tmp/verdaccio-pr/storage
          auth:
            htpasswd:
              file: /tmp/verdaccio-pr/htpasswd
              max_users: 1000
          uplinks:
            npmjs:
              url: https://registry.npmjs.org/
              cache: false
          packages:
            "@frontmcp/*":
              access: $all
              publish: $authenticated
              unpublish: $authenticated
            "frontmcp":
              access: $all
              publish: $authenticated
              unpublish: $authenticated
            "**":
              access: $all
              proxy: npmjs
          server:
            keepAliveTimeout: 60
          middlewares:
            audit:
              enabled: true
          log:
            type: stdout
            format: pretty
            level: info
          EOF

          # Create CI user for publishing
          npm install -g htpasswd
          htpasswd -cb /tmp/verdaccio-pr/htpasswd ci-publisher ci-publisher-pass

      - name: Install and start Verdaccio
        run: |
          npm install -g verdaccio

          verdaccio --config /tmp/verdaccio-pr/config.yaml --listen 4873 &
          echo $! > /tmp/verdaccio-pr/pid

          # Wait for Verdaccio to start
          for i in {1..30}; do
            if curl -s http://localhost:4873 > /dev/null 2>&1; then
              echo "Verdaccio is running"
              break
            fi
            echo "Waiting for Verdaccio... ($i/30)"
            sleep 1
          done

          if ! curl -s http://localhost:4873 > /dev/null 2>&1; then
            echo "::error::Failed to start Verdaccio"
            exit 1
          fi

      - name: Install ngrok via npm
        run: |
          # Install ngrok CLI globally
          npm install -g ngrok

      - name: Validate ngrok domain input
        if: ${{ inputs.ngrok_domain != '' }}
        run: |
          DOMAIN="${{ inputs.ngrok_domain }}"
          # Validate domain format: only allow alphanumeric, dots, and hyphens
          if ! [[ "$DOMAIN" =~ ^[a-zA-Z0-9][a-zA-Z0-9.-]*[a-zA-Z0-9]$ ]]; then
            echo "::error::Invalid ngrok domain format. Only alphanumeric characters, dots, and hyphens are allowed."
            exit 1
          fi
          # Reject dangerous characters that could enable command injection
          if [[ "$DOMAIN" =~ [\;\|\&\<\>\"\'\`\$\(\)\{\}\[\]\\] ]]; then
            echo "::error::Invalid characters in ngrok domain."
            exit 1
          fi
          echo "Domain validation passed: $DOMAIN"

      - name: Start ngrok tunnel
        id: ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # Configure auth token if available (optional but recommended for stable URLs)
          if [ -n "${NGROK_AUTH_TOKEN:-}" ]; then
            echo "Configuring ngrok with auth token..."
            # Use globally installed ngrok command directly
            ngrok config add-authtoken "$NGROK_AUTH_TOKEN"
          else
            echo "::warning::NGROK_AUTH_TOKEN not configured. Using ngrok without authentication (random URLs, rate limits may apply)."
          fi

          # Build ngrok arguments array (safe from injection)
          declare -a NGROK_ARGS=("http" "4873" "--log=stdout")

          # Add domain if provided (already validated above)
          NGROK_DOMAIN="${{ inputs.ngrok_domain }}"
          if [ -n "${NGROK_DOMAIN}" ]; then
            if [ -z "${NGROK_AUTH_TOKEN:-}" ]; then
              echo "::error::Custom domain requires NGROK_AUTH_TOKEN to be configured"
              exit 1
            fi
            echo "Using custom domain: ${NGROK_DOMAIN}"
            NGROK_ARGS+=("--domain=${NGROK_DOMAIN}")
          fi

          # Start ngrok using array expansion (prevents shell injection)
          # Use globally installed ngrok command directly
          ngrok "${NGROK_ARGS[@]}" > /tmp/ngrok.log 2>&1 &
          echo $! > /tmp/ngrok-pid

          # Wait for ngrok to start and get URL
          echo "Waiting for ngrok tunnel..."
          for i in {1..30}; do
            NGROK_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | \
              jq -r '.tunnels[0].public_url' 2>/dev/null || echo "")

            if [ -n "$NGROK_URL" ] && [ "$NGROK_URL" != "null" ]; then
              echo "ngrok tunnel ready: $NGROK_URL"
              break
            fi
            echo "Waiting for ngrok... ($i/30)"
            sleep 2
          done

          if [ -z "$NGROK_URL" ] || [ "$NGROK_URL" = "null" ]; then
            echo "::error::Failed to get ngrok URL"
            cat /tmp/ngrok.log || true
            exit 1
          fi

          echo "NGROK_URL=$NGROK_URL" >> "$GITHUB_ENV"
          echo "ngrok_url=$NGROK_URL" >> "$GITHUB_OUTPUT"

      - name: Calculate PR version
        id: version
        run: |
          PR_NUM="${{ inputs.pr_number }}"
          SHA="${{ steps.pr-info.outputs.sha }}"

          # Get current version from SDK package (the main package)
          CURRENT_VERSION=$(jq -r '.version' libs/sdk/package.json)
          echo "Current version: $CURRENT_VERSION"

          # Create PR version based on current version: e.g., 0.7.2-pr.205.00cc1a6
          VERSION="${CURRENT_VERSION}-pr.${PR_NUM}.${SHA}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "PR Version: $VERSION"

      - name: Update package versions
        run: |
          npx nx release version "${{ steps.version.outputs.version }}" \
            --git-tag=false --git-commit=false

      - name: Build all packages
        run: |
          npx nx run-many -t build --parallel=5

      - name: Authenticate with Verdaccio
        run: |
          # Login to local Verdaccio registry using basic auth (_auth not _authToken)
          npm set //localhost:4873/:_auth "$(echo -n 'ci-publisher:ci-publisher-pass' | base64)"

      - name: Publish packages to local Verdaccio
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PR_NUM="${{ inputs.pr_number }}"
          FAILED_PACKAGES=()
          PUBLISHED_PACKAGES=()

          # Dynamically discover all publishable packages using Nx
          echo "Discovering publishable packages..."
          PUBLISHABLE_PROJECTS=($(npx nx show projects --with-target publish 2>/dev/null))
          echo "Found ${#PUBLISHABLE_PROJECTS[@]} publishable packages: ${PUBLISHABLE_PROJECTS[*]}"

          for project in "${PUBLISHABLE_PROJECTS[@]}"; do
            # Determine dist path based on project location (libs/ or plugins/)
            if [ -d "libs/$project/dist" ]; then
              DIST_PATH="libs/$project/dist"
            elif [ -d "plugins/$project/dist" ]; then
              DIST_PATH="plugins/$project/dist"
            else
              echo "Warning: No dist folder found for $project"
              continue
            fi

            # Get actual package name from package.json
            PKG_NAME=$(jq -r '.name // empty' "$DIST_PATH/package.json" 2>/dev/null)
            if [ -z "$PKG_NAME" ] || [ "$PKG_NAME" = "null" ]; then
              PKG_NAME="@frontmcp/$project"
            fi

            echo "Publishing $PKG_NAME@$VERSION from $DIST_PATH..."
            if npm publish "$DIST_PATH" \
              --registry http://localhost:4873 \
              --access public \
              --tag "pr-$PR_NUM"; then
              PUBLISHED_PACKAGES+=("$PKG_NAME")
            else
              echo "Warning: publish failed for $PKG_NAME"
              FAILED_PACKAGES+=("$PKG_NAME")
            fi
          done

          echo ""
          echo "=== Publish Summary ==="
          echo "Published: ${#PUBLISHED_PACKAGES[@]} packages"
          echo "Failed: ${#FAILED_PACKAGES[@]} packages"

          if [ ${#FAILED_PACKAGES[@]} -gt 0 ]; then
            echo ""
            echo "::warning::Failed to publish: ${FAILED_PACKAGES[*]}"
          fi

          echo "All packages processed"

      - name: Create registry info artifact
        run: |
          mkdir -p /tmp/registry-info
          cat > /tmp/registry-info/README.md << EOF
          # PR Testing Registry

          ## Connection Info

          - **Registry URL:** ${{ env.NGROK_URL }}
          - **PR Number:** ${{ inputs.pr_number }}
          - **Version:** ${{ steps.version.outputs.version }}
          - **SHA:** ${{ steps.pr-info.outputs.full_sha }}
          - **Started:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Expires:** Approximately ${{ inputs.timeout_hours }} hour(s) from start

          ## Usage

          ### Install CLI (frontmcp):

          \`\`\`bash
          # Install globally
          npm install -g frontmcp@${{ steps.version.outputs.version }} --registry=${{ env.NGROK_URL }}

          # Or run directly with npx
          npx --registry=${{ env.NGROK_URL }} frontmcp@${{ steps.version.outputs.version }}
          \`\`\`

          ### Install SDK packages:

          \`\`\`bash
          npm install @frontmcp/sdk@${{ steps.version.outputs.version }} --registry=${{ env.NGROK_URL }}
          \`\`\`

          ### Configure .npmrc (for @frontmcp/* packages only):

          \`\`\`
          @frontmcp:registry=${{ env.NGROK_URL }}
          \`\`\`

          Then install normally:

          \`\`\`bash
          npm install @frontmcp/sdk@${{ steps.version.outputs.version }}
          \`\`\`

          **Note:** The \`frontmcp\` CLI is NOT scoped, so .npmrc won't work for it.
          You must use \`--registry\` flag for the CLI.

          ## Available Packages

          All packages with a \`publish\` target are automatically discovered and published.
          Check the workflow logs for the complete list of published packages.

          Common packages include:
          - **CLI**: \`frontmcp\` (non-scoped, use with \`npx frontmcp\` or \`npm install -g frontmcp\`)
          - **SDK**: \`@frontmcp/sdk\`, \`@frontmcp/adapters\`, \`@frontmcp/plugins\`, etc.
          - **Plugins**: \`@frontmcp/plugin-*\` packages

          All published with version \`${{ steps.version.outputs.version }}\`
          EOF

          echo "${{ env.NGROK_URL }}" > /tmp/registry-info/registry-url.txt

      - name: Upload registry info
        uses: actions/upload-artifact@v4
        with:
          name: pr-testing-registry-info
          path: /tmp/registry-info/
          retention-days: 1

      - name: Comment on PR with registry info
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- frontmcp-pr-testing-registry -->';
            const body = `${marker}
            ## üü¢ PR Testing Registry Available

            A temporary npm registry has been created for testing this PR.

            | Property | Value |
            |----------|-------|
            | **Registry URL** | \`${{ env.NGROK_URL }}\` |
            | **Version** | \`${{ steps.version.outputs.version }}\` |
            | **Expires** | ~${{ inputs.timeout_hours }} hour(s) from now |
            | **Started by** | @${{ github.actor }} |

            ### Quick Install

            \`\`\`bash
            npm install @frontmcp/sdk@${{ steps.version.outputs.version }} --registry=${{ env.NGROK_URL }}
            \`\`\`

            ### .npmrc Configuration

            \`\`\`
            @frontmcp:registry=${{ env.NGROK_URL }}
            \`\`\`

            ---
            <sub>To stop the registry early, [cancel the workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).</sub>`;

            // Find existing comment with our marker
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
            });

            const existingComment = comments.find(c => c.body.includes(marker));

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
              console.log(`Updated existing comment: ${existingComment.id}`);
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.pr_number }},
                body: body
              });
              console.log('Created new comment');
            }

      - name: Summary
        run: |
          echo "## PR Testing Registry Started" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Registry URL | \`${{ env.NGROK_URL }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| PR Number | #${{ inputs.pr_number }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Version | \`${{ steps.version.outputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Timeout | ${{ inputs.timeout_hours }} hours |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Install Command" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`bash" >> "$GITHUB_STEP_SUMMARY"
          echo "npm install @frontmcp/sdk@${{ steps.version.outputs.version }} --registry=${{ env.NGROK_URL }}" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"

      - name: Print install commands
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REGISTRY="${{ env.NGROK_URL }}"

          echo ""
          echo "============================================"
          echo "  INSTALL COMMANDS FOR PR TESTING REGISTRY"
          echo "============================================"
          echo ""
          echo "Registry URL: $REGISTRY"
          echo "Version: $VERSION"
          echo ""
          echo "--------------------------------------------"
          echo "  FRONTMCP CLI (npx frontmcp)"
          echo "--------------------------------------------"
          echo ""
          echo "# Install CLI globally (npm only - CLI is unscoped):"
          echo "npm install -g frontmcp@$VERSION --registry=$REGISTRY"
          echo ""
          echo "# Or run directly with npx:"
          echo "npx --registry=$REGISTRY frontmcp@$VERSION"
          echo ""
          echo "# NOTE: Yarn does not support --registry flag for global installs."
          echo "# Use npm for CLI installation."
          echo ""
          echo "--------------------------------------------"
          echo "  NPM INSTALL COMMANDS (@frontmcp/* packages)"
          echo "--------------------------------------------"
          echo ""
          echo "# All packages with 'publish' target are available."
          echo "# Common examples:"
          echo "npm install @frontmcp/sdk@$VERSION --registry=$REGISTRY"
          echo "npm install @frontmcp/adapters@$VERSION --registry=$REGISTRY"
          echo "npm install @frontmcp/plugins@$VERSION --registry=$REGISTRY"
          echo ""
          echo "# Plugin packages (all @frontmcp/plugin-* are available):"
          echo "npm install @frontmcp/plugin-config@$VERSION --registry=$REGISTRY"
          echo "npm install @frontmcp/plugin-remember@$VERSION --registry=$REGISTRY"
          echo "# ... and all other plugins"
          echo ""
          echo "--------------------------------------------"
          echo "  YARN CONFIGURATION (.yarnrc.yml)"
          echo "--------------------------------------------"
          echo ""
          echo "# Yarn Berry does not support --registry flag."
          echo "# Add to your .yarnrc.yml file:"
          echo ""
          echo "npmScopes:"
          echo "  frontmcp:"
          echo "    npmRegistryServer: \"$REGISTRY\""
          echo ""
          echo "# Then install packages normally:"
          echo "yarn add @frontmcp/sdk@$VERSION"
          echo "yarn add @frontmcp/adapters@$VERSION"
          echo ""
          echo "# For the CLI (unscoped), use npm instead:"
          echo "npm install -g frontmcp@$VERSION --registry=$REGISTRY"
          echo ""
          echo "--------------------------------------------"
          echo "  .NPMRC CONFIGURATION (npm/pnpm)"
          echo "--------------------------------------------"
          echo ""
          echo "# For @frontmcp/* scoped packages, add to .npmrc:"
          echo "@frontmcp:registry=$REGISTRY"
          echo ""
          echo "# Then install scoped packages normally:"
          echo "npm install @frontmcp/sdk@$VERSION"
          echo ""
          echo "# NOTE: The 'frontmcp' CLI is NOT scoped, so .npmrc won't work."
          echo "# You must use --registry flag for the CLI:"
          echo "npm install -g frontmcp@$VERSION --registry=$REGISTRY"
          echo "npx --registry=$REGISTRY frontmcp@$VERSION"
          echo ""
          echo "============================================"
          echo ""

      - name: Keep registry alive
        run: |
          TIMEOUT_SECONDS=$(( ${{ inputs.timeout_hours }} * 3600 ))
          START_TIME=$(date +%s)
          HEARTBEAT_INTERVAL=60

          echo "============================================"
          echo "Registry will run for ${{ inputs.timeout_hours }} hour(s)"
          echo "Registry URL: ${{ env.NGROK_URL }}"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "============================================"
          echo ""
          echo "Cancel the workflow to stop the registry early."
          echo ""

          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            REMAINING=$((TIMEOUT_SECONDS - ELAPSED))

            if [ $REMAINING -le 0 ]; then
              echo "Timeout reached. Shutting down..."
              break
            fi

            # Check if Verdaccio is still running
            if ! curl -s http://localhost:4873 > /dev/null 2>&1; then
              echo "Verdaccio stopped unexpectedly. Restarting..."

              # Clean up stale PID if exists
              if [ -f /tmp/verdaccio-pr/pid ]; then
                OLD_PID=$(cat /tmp/verdaccio-pr/pid)
                if kill -0 "$OLD_PID" 2>/dev/null; then
                  kill "$OLD_PID" 2>/dev/null || true
                  sleep 1
                fi
                rm -f /tmp/verdaccio-pr/pid
              fi

              # Wait for port to be free
              for j in {1..10}; do
                if ! ss -tlnp | grep -q ':4873 '; then
                  break
                fi
                echo "Waiting for port 4873 to be free... ($j/10)"
                sleep 1
              done

              # Start Verdaccio and save new PID
              verdaccio --config /tmp/verdaccio-pr/config.yaml --listen 4873 &
              echo $! > /tmp/verdaccio-pr/pid
              sleep 5
            fi

            # Check if ngrok is still running
            TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | \
              jq -r '.tunnels[0].public_url' 2>/dev/null || echo "")
            if [ -z "$TUNNEL_URL" ] || [ "$TUNNEL_URL" = "null" ]; then
              echo "::warning::ngrok tunnel may be down. Check the registry URL."
            fi

            HOURS_LEFT=$((REMAINING / 3600))
            MINS_LEFT=$(((REMAINING % 3600) / 60))
            echo "[$(date +%H:%M:%S)] Registry active. Time remaining: ${HOURS_LEFT}h ${MINS_LEFT}m"

            sleep $HEARTBEAT_INTERVAL
          done

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."

          # Kill Verdaccio
          if [ -f /tmp/verdaccio-pr/pid ]; then
            kill $(cat /tmp/verdaccio-pr/pid) 2>/dev/null || true
          fi

          # Kill ngrok
          if [ -f /tmp/ngrok-pid ]; then
            kill $(cat /tmp/ngrok-pid) 2>/dev/null || true
          fi

          # Cleanup temp files
          rm -rf /tmp/verdaccio-pr
          rm -f /tmp/ngrok.log /tmp/ngrok-pid

          echo "Cleanup complete"

      - name: Comment on PR (registry stopped)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- frontmcp-pr-testing-registry -->';
            const reason = '${{ job.status }}' === 'cancelled' ? 'Workflow cancelled' : 'Timeout reached';
            const body = `${marker}
            ## ‚èπÔ∏è PR Testing Registry Stopped

            The temporary npm registry for this PR has been shut down.

            | Property | Value |
            |----------|-------|
            | **Version** | \`${{ steps.version.outputs.version }}\` |
            | **Reason** | ${reason} |
            | **Stopped at** | ${new Date().toISOString()} |

            ---
            <sub>To start a new registry, [trigger the workflow again](${{ github.server_url }}/${{ github.repository }}/actions/workflows/pr-testing-registry.yml).</sub>`;

            // Find existing comment with our marker
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
            });

            const existingComment = comments.find(c => c.body.includes(marker));

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
              console.log(`Updated existing comment: ${existingComment.id}`);
            } else {
              // Create new comment (shouldn't happen normally, but handle edge case)
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.pr_number }},
                body: body
              });
              console.log('Created new comment');
            }
