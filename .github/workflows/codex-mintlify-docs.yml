name: "Codex → PR: update Mintlify docs & changelog (next/*)"

on:
  push:
    branches:
      - "next/**"
    # Prevent loop: if a push ONLY touches these paths, Codex won't run
    paths-ignore:
      - "docs/**"
      - "CHANGELOG.md"
      - "libs/**/README.md"
      - "README.md"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: codex-docs-${{ github.ref }}
  cancel-in-progress: false

jobs:
  docs:
    runs-on: ubuntu-latest
    environment: release

    env:
      CODEX_OUT: .codex-docs/patches.json

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Fail fast if env secret is not available
      - name: Ensure CODEX_OPENAI_KEY secret is set
        run: |
          if [ -z "${{ secrets.CODEX_OPENAI_KEY }}" ]; then
            echo "::error::CODEX_OPENAI_KEY (env: release) is not set. Add it under Settings → Environments → release → Secrets." >&2
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org/'

      - name: Install validator deps
        run: yarn install

      - name: Prepare diff context for Codex
        id: ctx
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .github/codex/prompts .codex-docs

          # ----------------------------------------
          # Base for diff/log = last published tag
          # ----------------------------------------
          # Find last stable semver tag reachable from HEAD:
          # - tags like v1.2.3 or 1.2.3
          # - no pre-release suffixes (no "-alpha.1", etc)
          LAST_TAG=$(
            git tag --merged HEAD \
            | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -n 1 \
            || true
          )

          if [ -n "$LAST_TAG" ]; then
            BASE=$(git rev-list -n 1 "$LAST_TAG")
            echo "Using last published version tag as base: ${LAST_TAG} (${BASE})"
          else
            echo "No semver release tag reachable from HEAD; falling back to default-branch merge-base."
            BASE=$(git merge-base HEAD "origin/${{ github.event.repository.default_branch }}") || \
                  BASE=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "$BASE" > .github/codex/prompts/base.txt

          # Unified diff: from last published release -> current next/x.y.z HEAD
          git diff "$BASE"...HEAD --unified=3 > .github/codex/prompts/diff.patch || true

          # Derive release version (prefer next/x.y.z, fallback to package.json)
          REF="${GITHUB_REF_NAME:-$(git rev-parse --abbrev-ref HEAD)}"
          if [[ "$REF" =~ ^next/([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION=$(node -e "try{console.log(require('./package.json').version||'0.0.0')}catch{console.log('0.0.0')}")
          fi
          echo "$VERSION" > .github/codex/prompts/version.txt
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Commit list (for changelog / docs / README synthesis)
          git log "$BASE"...HEAD --pretty=format:'%H%x09%s%x09%b' > .github/codex/prompts/commits.txt || true

          # ISO date
          date -u +"%Y-%m-%d" > .github/codex/prompts/date.txt

      - name: Add Codex prompt & schema
        run: |
          cat > .github/codex/prompts/update-docs.md <<'MDX'
          You are Codex. Task: propose minimal, precise updates to our **Mintlify** docs (under `docs/`), our root `CHANGELOG.md`, and READMEs for the current release.

          INPUTS (read-only files in workspace):
          - Unified diff:              `.github/codex/prompts/diff.patch`
          - Commit list (TSV):         `.github/codex/prompts/commits.txt`  # columns: sha<TAB>subject<TAB>body
          - Release version:           `.github/codex/prompts/version.txt`  # e.g., 1.2.3
          - Release date (UTC, ISO):   `.github/codex/prompts/date.txt`     # e.g., 2025-11-13

          SCOPE & PATHS
          - Mintlify docs: `docs/**/*.mdx` / `docs/**/*.md`.
          - Release notes page: `docs/updates.mdx` (Mintlify). Insert or update a **new top section** for this release.
          - Changelog: root `CHANGELOG.md` (Keep a Changelog format). Insert a new section for this version/date at the top.
          - Root README: `README.md` (repository homepage & npm default readme).
          - Library READMEs: `libs/**/README.md` (READMEs for libs that may be published to npm).
          - Do NOT touch other files (no config changes, no code files).

          RULES
          - **Release notes (`docs/updates.mdx`)**
            - Add a new section at the top for `v<version>` with date `<YYYY-MM-DD>`.
            - Summarize notable user-facing changes derived from commits and diff.
            - Group items under: Breaking changes, Features, Fixes, Docs, Performance, Refactor, Build/CI (omit empty groups).
            - Keep MDX valid (frontmatter/imports/components).

          - **Changelog (`CHANGELOG.md`)**
            - Follow Keep a Changelog style (Headings: `## [v<version>] - <YYYY-MM-DD>`).
            - Categorize entries using Conventional Commits (feat/fix/docs/perf/refactor/build/ci/chore) and mark **BREAKING CHANGES** clearly.
            - Include terse, imperative bullet points. Avoid internal-only noise.

          - **Root README (`README.md`)**
            - Reflect the new release where it matters: install commands, quickstart snippets, versioned examples, and top-level feature overview.
            - Keep content accurate for the whole repo, not just a single lib.
            - If no meaningful repo-level changes for this release, leave it as-is.

          - **Library READMEs (`libs/**/README.md`)**
            - Focus on libs that are clearly user-facing or affected by the diff (e.g., their code changed, their package.json version changed, or commits mention them).
            - For each updated README:
              - Ensure install instructions are correct (package name, registry, version ranges if relevant).
              - Update usage examples and API sections to match the current behavior.
              - Highlight notable changes that impact consumers of that lib.
            - Keep Markdown valid and simple; avoid large rewrites unless the current content is clearly outdated or misleading.

          - General
            - Prefer small, surgical edits. If a new doc is needed, create it under `docs/` with clear frontmatter.
            - Keep tone consistent with existing docs and READMEs.
            - If no changes are needed, return an empty patch set.

          OUTPUT (STRICT)
          - Return JSON that matches the output schema provided by the runner.
          - Each patch replaces the entire file content.

          HINTS
          - Use subjects/bodies in `commits.txt` to infer categories; de-duplicate merges.
          - If the same content belongs in multiple places (e.g. `docs/updates.mdx`, `CHANGELOG.md`, and a lib's README), adapt tone:
            - docs = narrative highlights,
            - changelog = terse, categorized bullets,
            - README = practical “how to use this” guidance and install/upgrade notes.

          Produce ONLY the JSON per schema.
          MDX

          cat > .github/codex/codex-output-schema.json <<'JSON'
          {
            "type": "object",
            "properties": {
              "patches": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "path": {
                      "type": "string",
                      "pattern": "^(docs\\/.+\\.(md|mdx)|CHANGELOG\\.md|README\\.md|libs\\/.+\\/README\\.md)$"
                    },
                    "content": { "type": "string", "minLength": 1, "maxLength": 500000 }
                  },
                  "required": ["path", "content"],
                  "additionalProperties": false
                }
              }
            },
            "required": ["patches"],
            "additionalProperties": false
          }
          JSON

      - name: Run Codex (read-only, structured output)
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.CODEX_OPENAI_KEY }}
          prompt-file: .github/codex/prompts/update-docs.md
          output-file: ${{ env.CODEX_OUT }}
          sandbox: read-only
          safety-strategy: drop-sudo
          output-schema-file: .github/codex/codex-output-schema.json

      - name: Apply & validate patches
        id: apply
        run: |
          set -euo pipefail

          node scripts/apply-doc-patches.mjs "$CODEX_OUT" | tee .codex-docs/apply.log

          # Any change in the working tree means Codex actually updated something
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Delete existing docs branch for this version (if any)
        if: ${{ steps.apply.outputs.changed == 'true' }}
        env:
          VERSION: ${{ steps.ctx.outputs.version }}
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="docs/codex/v${VERSION}"

          echo "Checking for existing branch ${BRANCH}..."

          # Fetch the branch ref if it exists on origin
          git fetch origin "+refs/heads/${BRANCH}:refs/remotes/origin/${BRANCH}" || true

          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            echo "Remote branch ${BRANCH} exists. Deleting remote..."
            git push origin --delete "${BRANCH}" || true
          else
            echo "No remote branch ${BRANCH}."
          fi

          if git show-ref --verify --quiet "refs/heads/${BRANCH}"; then
            echo "Local branch ${BRANCH} exists. Deleting local..."
            git branch -D "${BRANCH}" || true
          else
            echo "No local branch ${BRANCH}."
          fi

      - name: Create PR with docs & changelog & READMEs
        if: ${{ steps.apply.outputs.changed == 'true' }}
        uses: peter-evans/create-pull-request@v7
        with:
          branch: docs/codex/v${{ steps.ctx.outputs.version }}
          base: ${{ github.ref_name }}
          title: "docs: release notes, changelog & READMEs for v${{ steps.ctx.outputs.version }} (Codex)"
          commit-message: "docs(codex): update Mintlify docs, CHANGELOG & READMEs [auto]"
          labels: "documentation, automated, codex, release-notes"
          add-paths: |
            docs/**
            CHANGELOG.md
            README.md
            libs/**/README.md
          delete-branch: true
          body: |
            Codex proposed updates to:
            - **docs/updates.mdx** (Mintlify release notes)
            - **CHANGELOG.md**
            - **README.md** (root)
            - **libs/**/README.md** (affected publishable libs)

            for `v${{ steps.ctx.outputs.version }}` on branch `${{ github.ref_name }}`.

            See `.codex-docs/apply.log` for validation details.

      - name: Upload artifacts (debug)
        uses: actions/upload-artifact@v4
        with:
          name: codex-docs-artifacts
          path: |
            .codex-docs/**
            .github/codex/prompts/**
