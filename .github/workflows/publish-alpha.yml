name: Publish Alpha to Verdaccio

on:
  workflow_dispatch:
    inputs:
      base_version:
        description: "Base version (leave empty to use package.json)"
        required: false
        type: string
        default: ""

jobs:
  publish-alpha:
    runs-on: ubuntu-latest
    env:
      NX_DAEMON: "false"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Resolve synchronized libs
        id: libs
        shell: bash
        run: |
          set -euo pipefail
          PROJECTS=$(npx nx show projects -p tag:versioning:synchronized --type lib --json | node -e "console.log(JSON.parse(require('fs').readFileSync(0,'utf8')).join(','))")
          echo "projects=$PROJECTS" >> "$GITHUB_OUTPUT"
          echo "Found libs: $PROJECTS"

      - name: Calculate alpha version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          FULL_SHA=$(git rev-parse HEAD)
          SHA_SUFFIX="${FULL_SHA: -16}"
          if [ -n "${{ inputs.base_version }}" ]; then
            BASE="${{ inputs.base_version }}"
          else
            BASE=$(node -e "console.log(require('./package.json').version)")
          fi
          ALPHA_VERSION="${BASE}-alpha.${SHA_SUFFIX}"
          echo "version=$ALPHA_VERSION" >> "$GITHUB_OUTPUT"
          echo "Alpha version: $ALPHA_VERSION"

      - name: Update package versions with Nx
        run: npx nx release version ${{ steps.version.outputs.version }}

      - name: Build all packages
        run: npx nx run-many --targets=build --projects="${{ steps.libs.outputs.projects }}" --parallel

      - name: Configure npm for Verdaccio
        shell: bash
        run: |
          set -euo pipefail
          REGISTRY_HOST="${VERDACCIO_REGISTRY_URL#https://}"
          REGISTRY_HOST="${REGISTRY_HOST#http://}"
          echo "//${REGISTRY_HOST}/:_authToken=${VERDACCIO_TOKEN}" >> ~/.npmrc
        env:
          VERDACCIO_REGISTRY_URL: ${{ secrets.VERDACCIO_REGISTRY_URL }}
          VERDACCIO_TOKEN: ${{ secrets.VERDACCIO_TOKEN }}

      - name: Publish to Verdaccio
        run: npx nx release publish --registry=${{ secrets.VERDACCIO_REGISTRY_URL }}

      - name: Summary
        run: |
          echo "âœ… Published alpha version: ${{ steps.version.outputs.version }}"
          echo "ðŸ“¦ Packages: ${{ steps.libs.outputs.projects }}"
          echo "ðŸŽ¯ Registry: Verdaccio (private)"
