name: Publish libs on next/* merge

on:
  pull_request:
    types: [ closed ]

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: publish-next-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

jobs:
  publish:
    # Only run when:
    # - this is a PR close event
    # - the PR was merged
    # - the head branch is next/{semver}
    # - the base branch is the default branch (e.g. main)
    if: >
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'next/') &&
      github.event.pull_request.base.ref == github.event.repository.default_branch
    runs-on: ubuntu-latest
    environment: release
    env:
      NX_DAEMON: "false"

    steps:
      # -------------------------------
      # 1) Decide which commit is "the release"
      # -------------------------------
      - name: Determine release ref (branch or commit)
        id: release_ref
        shell: bash
        env:
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail

          # For merged PRs:
          # - merge_commit_sha is:
          #   * merge commit for "Merge" strategy
          #   * squashed commit on base branch for "Squash & merge"
          #   * updated commit for "Rebase & merge"
          #   (i.e. the commit that actually landed on the base branch)
          if [ -n "${MERGE_SHA:-}" ] && [ "$MERGE_SHA" != "null" ]; then
            REF="$MERGE_SHA"
            echo "Using merge_commit_sha as release ref: $REF"
          else
            # Edge cases: fall back to the base branch (e.g. main)
            REF="$BASE_REF"
            echo "merge_commit_sha missing; falling back to base branch: $REF"
          fi

          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      # -------------------------------
      # 2) Checkout the release commit
      # -------------------------------
      - name: Checkout release commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # This will be merge_commit_sha in normal cases
          ref: ${{ steps.release_ref.outputs.ref }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org/'

      # Ensure npm CLI has OIDC / trusted publishing support (>= 11.5.1)
      - name: Update npm CLI for trusted publishing
        run: npm install -g npm@latest

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: "Resolve synchronized libs (tag: versioning:synchronized)"
        id: synchronized
        shell: bash
        run: |
          set -euo pipefail
          PROJECTS=$(node -e "
            const { execSync } = require('child_process');
            const out = execSync('npx nx show projects -p tag:versioning:synchronized --type lib --json', { encoding: 'utf8' });
            const arr = JSON.parse(out);
            process.stdout.write(arr.join(','));
          ")
          if [ -z "$PROJECTS" ]; then
            echo 'synchronized_projects=' >> "$GITHUB_OUTPUT"
          else
            echo "synchronized_projects=$PROJECTS" >> "$GITHUB_OUTPUT"
            echo "Found synchronized libs: $PROJECTS"
          fi

      - name: "Resolve affected independent libs (tag: versioning:independent)"
        id: independent
        shell: bash
        run: |
          set -euo pipefail

          # Get all independent libraries
          ALL_INDEPENDENT=$(node -e "
            const { execSync } = require('child_process');
            const out = execSync('npx nx show projects -p tag:versioning:independent --type lib --json', { encoding: 'utf8' });
            const arr = JSON.parse(out);
            process.stdout.write(arr.join(','));
          ")

          if [ -z "$ALL_INDEPENDENT" ]; then
            echo 'independent_projects=' >> "$GITHUB_OUTPUT"
            echo "No independent libraries found"
            exit 0
          fi

          echo "All independent libs: $ALL_INDEPENDENT"

          # Get affected libraries
          AFFECTED=$(node -e "
            const { execSync } = require('child_process');
            try {
              const out = execSync('npx nx show projects --affected --type lib --json', { encoding: 'utf8' });
              const arr = JSON.parse(out);
              process.stdout.write(arr.join(','));
            } catch (e) {
              process.stdout.write('');
            }
          ")

          if [ -z "$AFFECTED" ]; then
            echo 'independent_projects=' >> "$GITHUB_OUTPUT"
            echo "No affected independent libraries"
            exit 0
          fi

          echo "Affected libs: $AFFECTED"

          # Find intersection: affected AND independent
          AFFECTED_INDEPENDENT=$(node -e "
            const all = '$ALL_INDEPENDENT'.split(',');
            const affected = '$AFFECTED'.split(',');
            const intersection = all.filter(lib => affected.includes(lib));
            process.stdout.write(intersection.join(','));
          ")

          echo "independent_projects=$AFFECTED_INDEPENDENT" >> "$GITHUB_OUTPUT"
          if [ -n "$AFFECTED_INDEPENDENT" ]; then
            echo "Affected independent libs to publish: $AFFECTED_INDEPENDENT"
          else
            echo "No affected independent libraries to publish"
          fi

      - name: "Collect all projects to publish"
        id: to_publish
        shell: bash
        run: |
          set -euo pipefail

          SYNC="${{ steps.synchronized.outputs.synchronized_projects }}"
          INDEP="${{ steps.independent.outputs.independent_projects }}"

          # Combine both lists
          if [ -n "$SYNC" ] && [ -n "$INDEP" ]; then
            ALL="$SYNC,$INDEP"
          elif [ -n "$SYNC" ]; then
            ALL="$SYNC"
          elif [ -n "$INDEP" ]; then
            ALL="$INDEP"
          else
            ALL=""
          fi

          echo "projects=$ALL" >> "$GITHUB_OUTPUT"
          if [ -n "$ALL" ]; then
            echo "Projects to publish: $ALL"
          else
            echo "No projects to publish"
          fi

      - name: Stop if nothing to publish
        if: ${{ steps.to_publish.outputs.projects == '' }}
        run: echo "Nothing to publish."

      - name: Build all projects to publish
        if: ${{ steps.to_publish.outputs.projects != '' }}
        run: |
          npx nx run-many --targets=build --projects="${{ steps.to_publish.outputs.projects }}" --parallel

      # -------------------------------
      # 3) Determine release version (from next/x.y.z or package.json)
      # -------------------------------
      - name: Determine release version
        id: version
        shell: bash
        env:
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail

          HEADREF="$PR_HEAD_REF"

          if [[ "$HEADREF" =~ ^next/([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            # Fallback: read root package.json version
            if [ ! -f "./package.json" ]; then
              echo "‚ö†Ô∏è  Warning: package.json not found in workspace root; using 0.0.0" >&2
              VERSION="0.0.0"
            else
              VERSION=$(node -e "try{console.log(require('./package.json').version||'0.0.0')}catch{console.log('0.0.0')}")
            fi
          fi

          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Could not determine a valid semver version (got: $VERSION)"; exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Release version: $VERSION"

      # -------------------------------
      # 4) Work out exact commit SHA to tag
      # -------------------------------
      - name: Determine release target SHA
        id: release_sha
        shell: bash
        env:
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          set -euo pipefail

          if [ -n "${MERGE_SHA:-}" ] && [ "$MERGE_SHA" != "null" ]; then
            SHA="$MERGE_SHA"
            echo "Using merge_commit_sha as release target: $SHA"
          else
            # Fallback: HEAD of checked-out ref
            SHA=$(git rev-parse HEAD)
            echo "Using HEAD as release target: $SHA"
          fi

          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      # -------------------------------
      # 4.5) Configure git user for tagging
      # -------------------------------
      - name: Configure git user
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "agentfront[bot]"
          git config user.email "agentfront[bot]@users.noreply.github.com"

      # -------------------------------
      # 5) Tag that commit (not just current HEAD somewhere else)
      # -------------------------------
      - name: Create and push git tag if missing
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v$VERSION"
          TARGET_SHA="${{ steps.release_sha.outputs.sha }}"

          git fetch --tags

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists."
          else
            echo "Creating tag $TAG at $TARGET_SHA"
            git tag -a "$TAG" "$TARGET_SHA" -m "Release $TAG"
            git push origin "$TAG"
          fi

      # -------------------------------
      # 6) Remove draft attributes from blog cards
      # -------------------------------
      - name: Remove draft blog cards
        shell: bash
        run: |
          set -euo pipefail
          echo "Removing draft attributes from BlogCard components..."
          node scripts/remove-blog-drafts.mjs

          # Check if there are changes
          if [ -n "$(git status --porcelain docs/)" ]; then
            git add docs/
            git commit -m "docs: remove draft attributes from blog cards for release"
            echo "‚úÖ Draft blog cards removed and committed"
          else
            echo "‚ÑπÔ∏è  No draft blog cards to remove"
          fi

      # -------------------------------
      # 7) Bump versions before publishing
      # -------------------------------
      - name: Bump synchronized library versions
        if: ${{ steps.synchronized.outputs.synchronized_projects != '' }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"

          echo "Bumping synchronized libraries to version $VERSION..."
          node scripts/bump-synchronized-versions.mjs "$VERSION"

      - name: Bump affected independent library versions (patch)
        if: ${{ steps.independent.outputs.independent_projects != '' }}
        shell: bash
        run: |
          set -euo pipefail

          INDEPENDENT="${{ steps.independent.outputs.independent_projects }}"
          if [ -z "$INDEPENDENT" ]; then
            echo "No independent libraries to bump"
            exit 0
          fi

          # Split by comma and bump each library
          IFS=',' read -ra LIBS <<< "$INDEPENDENT"
          for lib in "${LIBS[@]}"; do
            echo "Bumping $lib (patch)..."
            node scripts/bump-version.mjs "$lib" patch
          done

      - name: Commit version bumps
        if: ${{ steps.to_publish.outputs.projects != '' }}
        shell: bash
        run: |
          set -euo pipefail

          # Check if there are version changes
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore: bump versions for release ${{ steps.version.outputs.version }}"
            echo "‚úÖ Version bumps committed"
          else
            echo "‚ÑπÔ∏è  No version changes to commit"
          fi

      - name: Rebuild after version bumps
        if: ${{ steps.to_publish.outputs.projects != '' }}
        run: |
          npx nx run-many --targets=build --projects="${{ steps.to_publish.outputs.projects }}" --parallel

      # -------------------------------
      # 8) Publish to npm via Trusted Publishing
      # -------------------------------
      - name: Publish to npm
        if: ${{ steps.to_publish.outputs.projects != '' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Publishing selected projects via npm trusted publishing..."

          # Publish each project individually to ensure proper ordering
          IFS=',' read -ra PROJECTS <<< "${{ steps.to_publish.outputs.projects }}"
          for project in "${PROJECTS[@]}"; do
            echo "Publishing $project..."
            yarn nx run "$project:publish"
          done

      # -------------------------------
      # 9) Push version bump commit
      # -------------------------------
      - name: Push version bumps
        if: ${{ steps.to_publish.outputs.projects != '' }}
        shell: bash
        run: |
          set -euo pipefail

          # Check if there are commits to push
          if git log origin/${{ github.event.pull_request.base.ref }}..HEAD --oneline | grep -q "chore: bump versions"; then
            git push origin ${{ github.event.pull_request.base.ref }}
            echo "‚úÖ Version bumps pushed"
          else
            echo "‚ÑπÔ∏è  No version bump commits to push"
          fi

      # -------------------------------
      # 10) Create GitHub Release
      # -------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "‚úÖ Published projects: ${{ steps.to_publish.outputs.projects }}"
          echo "üì¶ Synchronized libs: ${{ steps.synchronized.outputs.synchronized_projects }}"
          echo "üîÑ Independent libs (affected): ${{ steps.independent.outputs.independent_projects }}"
          echo "üè∑Ô∏è  Release tag: v${{ steps.version.outputs.version }}"
          echo "üéØ Release commit: ${{ steps.release_sha.outputs.sha }}"
