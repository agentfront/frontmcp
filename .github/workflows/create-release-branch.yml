name: Create Release Branch (release/X.Y.x)

on:
  workflow_dispatch:
    inputs:
      major_version:
        description: "Major version (X)"
        required: true
        type: string
      minor_version:
        description: "Minor version (Y)"
        required: true
        type: string
      base_branch:
        description: "Branch to create from"
        required: false
        type: string
        default: main

permissions:
  contents: write

jobs:
  create:
    runs-on: ubuntu-latest
    environment: release
    env:
      NX_DAEMON: "false"

    steps:
      - name: Validate inputs
        env:
          MAJOR_VERSION: ${{ inputs.major_version }}
          MINOR_VERSION: ${{ inputs.minor_version }}
        run: |
          set -euo pipefail
          if ! [[ "$MAJOR_VERSION" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid major version: $MAJOR_VERSION. Must be a number."
            exit 1
          fi
          if ! [[ "$MINOR_VERSION" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid minor version: $MINOR_VERSION. Must be a number."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
          registry-url: "https://registry.npmjs.org/"

      - name: Install deps
        run: yarn install --frozen-lockfile
        env:
          npm_config_onnxruntime_node_install_cuda: skip

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if branch already exists
        id: check_branch
        shell: bash
        env:
          MAJOR: ${{ inputs.major_version }}
          MINOR: ${{ inputs.minor_version }}
          BASE: ${{ inputs.base_branch }}
        run: |
          set -euo pipefail

          # Validate BASE doesn't start with '-' (option injection prevention)
          if [[ "$BASE" == -* ]]; then
            echo "::error::Invalid base_branch: cannot start with '-'"
            exit 1
          fi

          BRANCH="release/${MAJOR}.${MINOR}.x"

          git fetch origin --tags

          if git ls-remote --heads origin "$BRANCH" | grep -q .; then
            echo "::error::Branch $BRANCH already exists!"
            exit 1
          fi

          echo "branch_name=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "Branch $BRANCH does not exist, proceeding..."

      - name: Determine version
        id: version
        shell: bash
        env:
          MAJOR: ${{ inputs.major_version }}
          MINOR: ${{ inputs.minor_version }}
        run: |
          set -euo pipefail

          VERSION="${MAJOR}.${MINOR}.0"
          RELEASE_LINE="${MAJOR}.${MINOR}"

          echo "initial_version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "release_line=$RELEASE_LINE" >> "$GITHUB_OUTPUT"

          echo "Initial version: $VERSION"
          echo "Release line: $RELEASE_LINE"

      - name: Create release branch
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${{ steps.check_branch.outputs.branch_name }}"
          BASE="${{ inputs.base_branch }}"

          # Validate BASE is a real git ref (tags already fetched)
          if ! git rev-parse --verify "origin/$BASE" >/dev/null 2>&1; then
            echo "::error::Invalid base_branch: '$BASE' does not exist on remote"
            exit 1
          fi

          git fetch origin "$BASE"
          git switch -c "$BRANCH" "origin/$BASE"

          echo "Created branch $BRANCH from $BASE"

      - name: Update package versions
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.initial_version }}"

          echo "Updating all synchronized libraries to v$VERSION..."
          npx nx release version "$VERSION" --git-tag=false --git-commit=false

      - name: Update CHANGELOG.md files
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.initial_version }}"
          DATE=$(date -u +%Y-%m-%d)

          # Update [Unreleased] markers in all CHANGELOG.md files (no-op if marker absent)
          for f in CHANGELOG.md libs/*/CHANGELOG.md plugins/*/CHANGELOG.md; do
            [ -f "$f" ] || continue
            if grep -q '## \[Unreleased\]' "$f"; then
              sed -i "s/## \[Unreleased\]/## [${VERSION}] - ${DATE}/" "$f"
              echo "Updated $f"
            fi
          done

      - name: Create release docs base marker
        shell: bash
        run: |
          set -euo pipefail
          # Store the current HEAD SHA for future diff calculations
          SHA=$(git rev-parse HEAD)
          echo "$SHA" > .release-docs-base
          echo "Created .release-docs-base marker with SHA: $SHA"

      - name: Commit release preparation
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ steps.version.outputs.initial_version }}"
          BRANCH="${{ steps.check_branch.outputs.branch_name }}"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A

            cat > /tmp/commit-msg <<COMMITMSG
          chore(release): initialize $BRANCH at v$VERSION

          - Set all synchronized libs to v$VERSION
          - Create .release-docs-base marker for docs diffing

          This is a long-lived release branch for the ${BRANCH#release/} series.
          Hotfixes and patches will be published from this branch.
          COMMITMSG

            git commit -F /tmp/commit-msg
            echo "Created release preparation commit"
          else
            echo "No changes to commit"
            git commit --allow-empty -m "chore(release): initialize $BRANCH at v$VERSION"
          fi

      - name: Push release branch
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ steps.check_branch.outputs.branch_name }}"

          git push --set-upstream origin "$BRANCH"
          echo "Pushed branch $BRANCH"

      - name: Summary
        run: |
          echo "## Release Branch Created" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Branch | \`${{ steps.check_branch.outputs.branch_name }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Initial version | \`${{ steps.version.outputs.initial_version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Release line | \`${{ steps.version.outputs.release_line }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Base branch | \`${{ inputs.base_branch }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Next Steps" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Open PRs targeting \`${{ steps.check_branch.outputs.branch_name }}\` for hotfixes" >> "$GITHUB_STEP_SUMMARY"
          echo "2. Use **Publish Release** workflow to publish versions" >> "$GITHUB_STEP_SUMMARY"
          echo "3. Cherry-picks to main will be prompted automatically" >> "$GITHUB_STEP_SUMMARY"
