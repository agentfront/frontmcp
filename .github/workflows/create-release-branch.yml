name: Create Release Branch (release/X.Y.x)

on:
  workflow_dispatch:
    inputs:
      major_version:
        description: "Major version (X)"
        required: true
        type: string
      minor_version:
        description: "Minor version (Y)"
        required: true
        type: string
      base_branch:
        description: "Branch to create from"
        required: false
        type: string
        default: main

permissions:
  contents: write

jobs:
  create:
    runs-on: ubuntu-latest
    environment: release
    env:
      NX_DAEMON: "false"

    steps:
      - name: Validate inputs
        run: |
          if ! [[ "${{ inputs.major_version }}" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid major version: ${{ inputs.major_version }}. Must be a number."
            exit 1
          fi
          if ! [[ "${{ inputs.minor_version }}" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid minor version: ${{ inputs.minor_version }}. Must be a number."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Node version
        id: node-version
        run: echo "version=$(cat .nvmrc)" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.node-version.outputs.version }}
          cache: "yarn"
          registry-url: "https://registry.npmjs.org/"

      - name: Install deps
        run: yarn install --frozen-lockfile
        env:
          npm_config_onnxruntime_node_install_cuda: skip

      - name: Configure git user
        run: |
          git config user.name "agentfront[bot]"
          git config user.email "agentfront[bot]@users.noreply.github.com"

      - name: Determine branch and version
        id: branch
        shell: bash
        run: |
          set -euo pipefail

          MAJOR="${{ inputs.major_version }}"
          MINOR="${{ inputs.minor_version }}"
          BASE="${{ inputs.base_branch }}"

          # Validate BASE doesn't start with '-' (option injection prevention)
          if [[ "$BASE" == -* ]]; then
            echo "::error::Invalid base_branch: cannot start with '-'"
            exit 1
          fi

          BRANCH="release/${MAJOR}.${MINOR}.x"
          VERSION="${MAJOR}.${MINOR}.0"
          RELEASE_LINE="${MAJOR}.${MINOR}"

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "release_line=$RELEASE_LINE" >> "$GITHUB_OUTPUT"
          echo "base=$BASE" >> "$GITHUB_OUTPUT"

          echo "Branch: $BRANCH"
          echo "Initial version: $VERSION"
          echo "Release line: $RELEASE_LINE"
          echo "Base branch: $BASE"

      - name: Check if branch already exists
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ steps.branch.outputs.branch }}"

          git fetch origin --tags

          if git ls-remote --heads origin "$BRANCH" | grep -q .; then
            echo "::error::Branch $BRANCH already exists!"
            exit 1
          fi

          echo "Branch $BRANCH does not exist, proceeding..."

      - name: Create release branch
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${{ steps.branch.outputs.branch }}"
          BASE="${{ steps.branch.outputs.base }}"

          # Validate BASE is a real git ref
          git fetch origin --tags
          if ! git rev-parse --verify "origin/$BASE" >/dev/null 2>&1; then
            echo "::error::Invalid base_branch: '$BASE' does not exist on remote"
            exit 1
          fi

          git fetch origin "$BASE"
          git checkout -b "$BRANCH" "origin/$BASE"

          echo "Created branch $BRANCH from $BASE"

      - name: Get version context
        id: versions
        shell: bash
        run: |
          set -euo pipefail

          # Get last release tag for archival purposes
          # Note: exclude pre-release tags (e.g., -rc/-beta) so new-minor detection
          # doesn't get confused by pre-releases on the target minor.
          # Wrap grep in command group to handle no matches gracefully under set -euo pipefail
          LAST_TAG=$(
            git tag --list "v*" --sort=-version:refname | {
              grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' || true
            } | head -n1 || echo ""
          )
          if [ -n "$LAST_TAG" ]; then
            LAST_VERSION="${LAST_TAG#v}"
            LAST_MINOR=$(echo "$LAST_VERSION" | awk -F. '{print $1"."$2}')
          else
            LAST_VERSION=""
            LAST_MINOR=""
          fi

          NEXT_MINOR="${{ steps.branch.outputs.release_line }}"

          echo "last_version=$LAST_VERSION" >> "$GITHUB_OUTPUT"
          echo "last_minor=$LAST_MINOR" >> "$GITHUB_OUTPUT"
          echo "next_minor=$NEXT_MINOR" >> "$GITHUB_OUTPUT"

          echo "Last version: $LAST_VERSION (minor: $LAST_MINOR)"
          echo "Next minor: $NEXT_MINOR"

      - name: Update package versions
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.branch.outputs.version }}"

          echo "Updating all synchronized libraries to v$VERSION..."
          npx nx release version "$VERSION" --git-tag=false --git-commit=false

      - name: Create release docs base marker
        shell: bash
        run: |
          # Store the SHA of the base branch for future diff calculations
          # This allows trigger-docs-update.yml to calculate proper diffs
          BASE_SHA=$(git rev-parse "origin/${{ steps.branch.outputs.base }}")
          echo "$BASE_SHA" > .release-docs-base
          echo "Created .release-docs-base marker with SHA: $BASE_SHA"

      - name: Archive and publish docs (new minor version only)
        shell: bash
        run: |
          set -euo pipefail

          LAST_MINOR="${{ steps.versions.outputs.last_minor }}"
          NEXT_MINOR="${{ steps.versions.outputs.next_minor }}"

          if [ -z "$LAST_MINOR" ]; then
            echo "No previous version to archive, skipping docs archival"
            exit 0
          fi

          # Only archive and publish if this is a new minor version
          if [ "$LAST_MINOR" = "$NEXT_MINOR" ]; then
            echo "Same minor version ($NEXT_MINOR), skipping docs archival"
            exit 0
          fi

          if [ -f "scripts/archive-and-publish-docs.mjs" ]; then
            echo "Running archive and publish docs script..."
            node scripts/archive-and-publish-docs.mjs "$LAST_MINOR" "$NEXT_MINOR"
          else
            echo "Archive docs script not found, skipping"
          fi

      - name: Commit release preparation
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ steps.branch.outputs.version }}"
          BRANCH="${{ steps.branch.outputs.branch }}"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A

            cat > /tmp/commit-msg <<COMMITMSG
          chore(release): initialize $BRANCH at v$VERSION

          - Set all synchronized libs to v$VERSION
          - Create .release-docs-base marker for docs diffing
          - Archive previous docs (if new minor version)

          This is a long-lived release branch for the ${BRANCH#release/} series.
          Hotfixes and patches will be published from this branch.
          COMMITMSG

            git commit -F /tmp/commit-msg
            echo "Created release preparation commit"
          else
            echo "No changes to commit"
            git commit --allow-empty -m "chore(release): initialize $BRANCH at v$VERSION"
          fi

      - name: Push release branch
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ steps.branch.outputs.branch }}"

          git push --set-upstream origin "$BRANCH"
          echo "Pushed branch $BRANCH"

      - name: Summary
        run: |
          echo "## Release Branch Created" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Branch | \`${{ steps.branch.outputs.branch }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Initial version | \`${{ steps.branch.outputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Release line | \`${{ steps.branch.outputs.release_line }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Base branch | \`${{ steps.branch.outputs.base }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Next Steps" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Open PRs targeting \`${{ steps.branch.outputs.branch }}\` for hotfixes" >> "$GITHUB_STEP_SUMMARY"
          echo "2. Use **Publish Release** workflow to publish versions" >> "$GITHUB_STEP_SUMMARY"
          echo "3. Cherry-picks to main will be prompted automatically" >> "$GITHUB_STEP_SUMMARY"
