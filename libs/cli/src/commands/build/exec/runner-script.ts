/**
 * Bash runner script generation.
 * The runner checks Node.js, loads .env, and runs the bundle.
 */

import { FrontmcpExecConfig } from './config';

export function generateRunnerScript(config: FrontmcpExecConfig, cliMode?: boolean): string {
  const name = config.name;
  const nodeVersion = config.nodeVersion || '>=22.0.0';
  const minNodeMajor = extractMinMajor(nodeVersion);

  const bundle = cliMode
    ? `\${SCRIPT_DIR}/${name}-cli.bundle.js`
    : `\${SCRIPT_DIR}/${name}.bundle.js`;

  const comment = cliMode
    ? `# ${name} — FrontMCP CLI Executable`
    : `# ${name} — FrontMCP Server Runner`;

  return `#!/usr/bin/env bash
set -euo pipefail

${comment}
# Generated by frontmcp build --exec${cliMode ? ' --cli' : ''}

SCRIPT_DIR="$(cd "$(dirname "\${BASH_SOURCE[0]}")" && pwd)"
BUNDLE="${bundle}"

# Check Node.js
if ! command -v node &> /dev/null; then
  echo "Error: Node.js is required but not installed."
  echo "Install Node.js ${nodeVersion}: https://nodejs.org"
  exit 1
fi

NODE_MAJOR=$(node -e "console.log(process.versions.node.split('.')[0])")
if [ "\${NODE_MAJOR}" -lt "${minNodeMajor}" ]; then
  echo "Error: Node.js ${nodeVersion} required, found v$(node -v)"
  exit 1
fi

# Check bundle exists
if [ ! -f "\${BUNDLE}" ]; then
  echo "Error: Bundle not found at \${BUNDLE}"
  echo "Run 'frontmcp build --exec${cliMode ? ' --cli' : ''}' to create it."
  exit 1
fi

# Load .env if present
ENV_FILE="\${SCRIPT_DIR}/.env"
if [ -f "\${ENV_FILE}" ]; then
  set -a
  # shellcheck disable=SC1090
  source "\${ENV_FILE}"
  set +a
fi

# Run
exec node "\${BUNDLE}" "$@"
`;
}

function extractMinMajor(version: string): number {
  const match = version.match(/(\d+)/);
  return match ? parseInt(match[1], 10) : 22;
}
