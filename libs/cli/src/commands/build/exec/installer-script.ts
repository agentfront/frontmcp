/**
 * Bash installer script generation.
 * Supports interactive and --yes (silent) modes.
 */

import { FrontmcpExecConfig } from './config';

export function generateInstallerScript(config: FrontmcpExecConfig): string {
  const name = config.name;
  const nativeAddons = config.dependencies?.nativeAddons || [];
  const storageType = config.storage?.type || 'none';
  const nodeVersion = config.nodeVersion || '>=22.0.0';
  const minNodeMajor = extractMinMajor(nodeVersion);

  return `#!/usr/bin/env bash
set -euo pipefail

# install-${name}.sh â€” FrontMCP App Installer
# Generated by frontmcp build --exec

SCRIPT_DIR="$(cd "$(dirname "\${BASH_SOURCE[0]}")" && pwd)"
APP_NAME="${name}"
INSTALL_DIR="\${HOME}/.frontmcp/apps/\${APP_NAME}"
SILENT=false

# Parse args
for arg in "$@"; do
  case "\${arg}" in
    --yes|-y) SILENT=true ;;
  esac
done

echo "Installing \${APP_NAME}..."
echo ""

# Check Node.js
if ! command -v node &> /dev/null; then
  echo "Error: Node.js is required."
  echo "Install Node.js ${nodeVersion}: https://nodejs.org"
  exit 1
fi

NODE_MAJOR=$(node -e "console.log(process.versions.node.split('.')[0])")
if [ "\${NODE_MAJOR}" -lt "${minNodeMajor}" ]; then
  echo "Error: Node.js ${nodeVersion} required, found v$(node -v)"
  exit 1
fi

# Create install directory
mkdir -p "\${INSTALL_DIR}"

# Copy files
cp "\${SCRIPT_DIR}/${name}.bundle.js" "\${INSTALL_DIR}/"
cp "\${SCRIPT_DIR}/${name}.manifest.json" "\${INSTALL_DIR}/"
cp "\${SCRIPT_DIR}/${name}" "\${INSTALL_DIR}/"
chmod +x "\${INSTALL_DIR}/${name}"

${nativeAddons.length > 0 ? generateNativeAddonInstall(nativeAddons) : '# No native addons required'}

${storageType === 'sqlite' ? generateSqliteSetup(name) : '# No storage setup required'}

# Run questionnaire if manifest has setup and not silent
if [ "\${SILENT}" = false ] && command -v frontmcp &> /dev/null; then
  if node -e "const m=require('\${INSTALL_DIR}/${name}.manifest.json'); process.exit(m.setup ? 0 : 1)" 2>/dev/null; then
    echo ""
    echo "Running setup questionnaire..."
    frontmcp configure "\${APP_NAME}"
  fi
fi

echo ""
echo "Installed to \${INSTALL_DIR}"
echo ""
echo "Start with:"
echo "  frontmcp start \${APP_NAME}"
echo ""
`;
}

function generateNativeAddonInstall(addons: string[]): string {
  const addonList = addons.map((a) => `"${a}"`).join(' ');
  return `# Install native addons
echo "Installing native dependencies..."
(cd "\${INSTALL_DIR}" && npm init -y --silent 2>/dev/null && npm install ${addonList} --save --silent)
`;
}

function generateSqliteSetup(name: string): string {
  return `# Create SQLite data directory
DATA_DIR="\${HOME}/.frontmcp/data/${name}"
mkdir -p "\${DATA_DIR}"
echo "FRONTMCP_SQLITE_PATH=\${DATA_DIR}/${name}.sqlite" >> "\${INSTALL_DIR}/.env"
`;
}

function extractMinMajor(version: string): number {
  const match = version.match(/(\d+)/);
  return match ? parseInt(match[1], 10) : 22;
}
