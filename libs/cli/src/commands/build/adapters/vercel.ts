import { AdapterTemplate } from '../types';

/**
 * Vercel adapter - serverless deployment on Vercel.
 * Compiles to ESM and generates a handler that exports the Express app.
 *
 * @see https://vercel.com/docs/frameworks/express
 */
export const vercelAdapter: AdapterTemplate = {
  moduleFormat: 'esnext',

  getEntryTemplate: (mainModulePath: string) => `// Auto-generated Vercel entry point
// Generated by: frontmcp build --adapter vercel
process.env.FRONTMCP_SERVERLESS = '1';

import '${mainModulePath}';
import { getServerlessHandlerAsync } from '@frontmcp/sdk';

let handlerPromise = null;

export default async function handler(req, res) {
  if (!handlerPromise) {
    handlerPromise = getServerlessHandlerAsync();
  }
  const app = await handlerPromise;
  return app(req, res);
}
`,

  getConfig: () => ({
    version: 2,
    builds: [{ src: 'dist/index.js', use: '@vercel/node' }],
    routes: [{ src: '/(.*)', dest: '/dist/index.js' }],
  }),

  configFileName: 'vercel.json',
};
