import { AdapterTemplate } from '../types';

/**
 * Vercel adapter - serverless deployment on Vercel.
 * Compiles to ESM, bundles with rspack to CJS for maximum compatibility.
 *
 * The build process:
 * 1. TypeScript compiles to ESM in dist/
 * 2. serverless-setup.js is generated (sets FRONTMCP_SERVERLESS=1)
 * 3. index.js imports setup first, then main module
 * 4. rspack bundles everything into handler.cjs
 *
 * @see https://vercel.com/docs/frameworks/express
 */
export const vercelAdapter: AdapterTemplate = {
  moduleFormat: 'esnext',
  shouldBundle: true,
  bundleOutput: 'handler.cjs',

  getSetupTemplate: () => `// Serverless environment setup - MUST be imported first
// This sets FRONTMCP_SERVERLESS before any decorators run
// Required because ESM hoists imports before other statements
process.env.FRONTMCP_SERVERLESS = '1';
`,

  getEntryTemplate: (mainModulePath: string) => `// Auto-generated Vercel entry point
// Generated by: frontmcp build --adapter vercel
import './serverless-setup.js';
import '${mainModulePath}';
import { getServerlessHandlerAsync } from '@frontmcp/sdk';

let handlerPromise = null;

export default async function handler(req, res) {
  if (!handlerPromise) {
    handlerPromise = getServerlessHandlerAsync();
  }
  const app = await handlerPromise;
  return app(req, res);
}
`,

  getConfig: () => ({
    version: 2,
    builds: [{ src: 'dist/handler.cjs', use: '@vercel/node' }],
    routes: [{ src: '/(.*)', dest: '/dist/handler.cjs' }],
  }),

  configFileName: 'vercel.json',
};
