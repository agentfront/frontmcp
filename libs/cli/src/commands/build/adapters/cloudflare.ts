import { AdapterTemplate } from '../types.js';

/**
 * Cloudflare Workers adapter - edge deployment on Cloudflare.
 * Compiles to CommonJS and adapts the Express app to Cloudflare's fetch API.
 *
 * @see https://developers.cloudflare.com/workers/
 */
export const cloudflareAdapter: AdapterTemplate = {
  moduleFormat: 'commonjs',

  getEntryTemplate: (mainModulePath: string) => `// Auto-generated Cloudflare Workers entry point
// Generated by: frontmcp build --adapter cloudflare
process.env.FRONTMCP_SERVERLESS = '1';

require('${mainModulePath}');
const { getServerlessHandlerAsync } = require('@frontmcp/sdk');

let app = null;

async function handleRequest(request) {
  if (!app) {
    app = await getServerlessHandlerAsync();
  }

  // Convert Cloudflare Request to Node.js format
  const url = new URL(request.url);
  const req = {
    method: request.method,
    url: url.pathname + url.search,
    headers: Object.fromEntries(request.headers),
    body: request.body,
  };

  return new Promise((resolve) => {
    const res = {
      statusCode: 200,
      headers: {},
      body: '',
      status(code) { this.statusCode = code; return this; },
      setHeader(key, value) { this.headers[key] = value; },
      json(data) {
        this.headers['Content-Type'] = 'application/json';
        this.body = JSON.stringify(data);
        resolve(new Response(this.body, {
          status: this.statusCode,
          headers: this.headers,
        }));
      },
      send(data) {
        this.body = data;
        resolve(new Response(this.body, {
          status: this.statusCode,
          headers: this.headers,
        }));
      },
      end() {
        resolve(new Response(this.body, {
          status: this.statusCode,
          headers: this.headers,
        }));
      },
    };
    app(req, res);
  });
}

module.exports = {
  async fetch(request, env, ctx) {
    return handleRequest(request);
  }
};
`,

  getConfig: (_cwd: string) => `name = "frontmcp-worker"
main = "dist/index.js"
compatibility_date = "2024-01-01"
`,

  configFileName: 'wrangler.toml',
};
