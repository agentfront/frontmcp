import { AdapterTemplate } from '../types';

/**
 * AWS Lambda adapter - serverless deployment on AWS Lambda.
 * Compiles to ESM, bundles with rspack to CJS for maximum compatibility.
 *
 * Prerequisites:
 *   npm install @codegenie/serverless-express
 *
 * The build process:
 * 1. TypeScript compiles to ESM in dist/
 * 2. serverless-setup.js is generated (sets FRONTMCP_SERVERLESS=1)
 * 3. index.js imports setup first, then main module
 * 4. rspack bundles everything into handler.cjs
 *
 * @see https://github.com/codegenie/serverless-express
 */
export const lambdaAdapter: AdapterTemplate = {
  moduleFormat: 'esnext',
  shouldBundle: true,
  bundleOutput: 'handler.cjs',

  getSetupTemplate: () => `// Serverless environment setup - MUST be imported first
// This sets FRONTMCP_SERVERLESS before any decorators run
// Required because ESM hoists imports before other statements
process.env.FRONTMCP_SERVERLESS = '1';
`,

  getEntryTemplate: (mainModulePath: string) => `// Auto-generated AWS Lambda entry point
// Generated by: frontmcp build --adapter lambda
//
// IMPORTANT: This adapter requires @codegenie/serverless-express
// Install it with: npm install @codegenie/serverless-express
//
import './serverless-setup.js';
import '${mainModulePath}';
import { getServerlessHandlerAsync } from '@frontmcp/sdk';
import serverlessExpress from '@codegenie/serverless-express';

let serverlessExpressInstance = null;

async function setup() {
  const app = await getServerlessHandlerAsync();
  serverlessExpressInstance = serverlessExpress({ app });
}

export const handler = async (event, context) => {
  if (!serverlessExpressInstance) {
    await setup();
  }
  return serverlessExpressInstance(event, context);
};
`,

  // No config file - user manages serverless.yml, SAM template, or CDK
};
