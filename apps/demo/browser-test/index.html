<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FrontMCP Browser Demo</title>
    <style>
      :root {
        --bg-primary: #1a1a2e;
        --bg-secondary: #16213e;
        --bg-tertiary: #0f3460;
        --accent: #00d4ff;
        --accent-dim: #0097b8;
        --text: #e0e0e0;
        --text-muted: #8892a4;
        --success: #00e676;
        --error: #ff5252;
        --warning: #ffab40;
        --border: #2a3a5e;
        --radius: 8px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-primary);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Header */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border);
        background: var(--bg-secondary);
      }
      .header h1 {
        font-size: 1.25rem;
        color: var(--accent);
        font-weight: 600;
      }
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 500;
        background: var(--bg-tertiary);
      }
      .status-badge .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-muted);
      }
      .status-badge.ready .dot {
        background: var(--warning);
      }
      .status-badge.connected .dot {
        background: var(--success);
      }
      .status-badge.error .dot {
        background: var(--error);
      }

      /* Button bar */
      .button-bar {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        border-bottom: 1px solid var(--border);
        background: var(--bg-secondary);
      }
      button {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg-tertiary);
        color: var(--text);
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.15s;
      }
      button:hover:not(:disabled) {
        border-color: var(--accent);
        color: var(--accent);
      }
      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      button.primary {
        background: var(--accent-dim);
        border-color: var(--accent);
        color: white;
      }
      button.primary:hover:not(:disabled) {
        background: var(--accent);
        color: var(--bg-primary);
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 0;
        border-bottom: 1px solid var(--border);
        background: var(--bg-secondary);
        padding: 0 1.5rem;
      }
      .tab {
        padding: 0.6rem 1.25rem;
        border: none;
        border-bottom: 2px solid transparent;
        border-radius: 0;
        background: none;
        color: var(--text-muted);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
      }
      .tab:hover {
        color: var(--text);
      }
      .tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }

      /* Content area */
      .content {
        display: flex;
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }

      /* List panel */
      .list-panel {
        width: 240px;
        min-width: 240px;
        border-right: 1px solid var(--border);
        overflow-y: auto;
        background: var(--bg-secondary);
      }
      .list-item {
        padding: 0.6rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        font-size: 0.85rem;
        transition: background 0.1s;
      }
      .list-item:hover {
        background: var(--bg-tertiary);
      }
      .list-item.active {
        background: var(--bg-tertiary);
        border-left: 3px solid var(--accent);
        color: var(--accent);
      }
      .list-item .item-type {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .list-empty {
        padding: 1.5rem;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.85rem;
      }

      /* Detail panel */
      .detail-panel {
        flex: 1;
        padding: 1.25rem;
        overflow-y: auto;
      }
      .detail-panel h3 {
        color: var(--accent);
        margin-bottom: 0.75rem;
        font-size: 1rem;
      }
      .detail-panel .description {
        color: var(--text-muted);
        margin-bottom: 1rem;
        font-size: 0.85rem;
      }

      /* Form elements */
      .form-group {
        margin-bottom: 0.75rem;
      }
      .form-group label {
        display: block;
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
      }
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg-primary);
        color: var(--text);
        font-size: 0.85rem;
        font-family: inherit;
      }
      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--accent);
      }
      .form-group .field-type {
        font-size: 0.7rem;
        color: var(--text-muted);
        font-family: monospace;
      }

      /* Output log */
      .output-container {
        border-top: 1px solid var(--border);
        background: var(--bg-secondary);
        height: 260px;
        min-height: 100px;
        display: flex;
        flex-direction: column;
      }
      .output-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.4rem 1rem;
        border-bottom: 1px solid var(--border);
        font-size: 0.8rem;
        color: var(--text-muted);
        flex-shrink: 0;
      }
      .output-log {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
        font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
        font-size: 0.78rem;
        line-height: 1.5;
      }
      .log-entry {
        padding: 0.35rem 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.25rem;
      }
      .log-entry.success {
        background: rgba(0, 230, 118, 0.08);
      }
      .log-entry.error {
        background: rgba(255, 82, 82, 0.08);
      }
      .log-entry .log-time {
        color: var(--text-muted);
        margin-right: 0.5rem;
      }
      .log-entry .log-op {
        color: var(--accent);
        font-weight: 500;
        margin-right: 0.5rem;
      }
      .log-entry.error .log-op {
        color: var(--error);
      }
      .log-entry .log-data {
        color: var(--text);
        white-space: pre-wrap;
        word-break: break-word;
      }

      /* Placeholder state */
      .placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-muted);
        font-size: 0.9rem;
        text-align: center;
        padding: 2rem;
      }

      /* Error banner */
      .error-banner {
        padding: 1rem 1.5rem;
        background: rgba(255, 82, 82, 0.15);
        border-bottom: 1px solid var(--error);
        color: var(--error);
        font-size: 0.85rem;
      }
      .error-banner code {
        display: block;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: var(--bg-primary);
        border-radius: 4px;
        color: var(--text);
        font-size: 0.8rem;
      }

      /* Resize handle (visual only) */
      .output-container {
        resize: vertical;
        overflow: hidden;
      }
    </style>

    <script type="importmap">
      {
        "imports": {
          "zod": "https://cdn.jsdelivr.net/npm/zod@4.3.6/index.js",
          "zod/v3": "https://cdn.jsdelivr.net/npm/zod@4.3.6/v3/index.js",
          "zod/v4": "https://cdn.jsdelivr.net/npm/zod@4.3.6/v4/index.js",
          "zod/v4/core": "https://cdn.jsdelivr.net/npm/zod@4.3.6/v4/core/index.js",
          "zod/v4-mini": "https://cdn.jsdelivr.net/npm/zod@4.3.6/v4-mini/index.js",
          "reflect-metadata": "https://esm.sh/reflect-metadata@0.2.2"
        }
      }
    </script>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <h1>FrontMCP Browser Demo</h1>
      <div class="status-badge" id="statusBadge">
        <span class="dot"></span>
        <span id="statusText">Not initialized</span>
      </div>
    </div>

    <!-- Error banner (hidden by default) -->
    <div class="error-banner" id="errorBanner" style="display: none"></div>

    <!-- Button bar -->
    <div class="button-bar">
      <button id="btnInit" class="primary">Initialize Server</button>
      <button id="btnConnect" disabled>Connect Client</button>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabBar">
      <button class="tab active" data-tab="tools">Tools</button>
      <button class="tab" data-tab="resources">Resources</button>
      <button class="tab" data-tab="prompts">Prompts</button>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="list-panel" id="listPanel">
        <div class="list-empty">Initialize server to see items</div>
      </div>
      <div class="detail-panel" id="detailPanel">
        <div class="placeholder">Select an item from the list</div>
      </div>
    </div>

    <!-- Output log -->
    <div class="output-container">
      <div class="output-header">
        <span>Output Log</span>
        <button id="btnClear" style="padding: 0.2rem 0.5rem; font-size: 0.75rem">Clear</button>
      </div>
      <div class="output-log" id="outputLog"></div>
    </div>

    <!-- Main application script -->
    <script type="module">
      // ═══════════════════════════════════════════════════════════════════
      // SDK Import
      // ═══════════════════════════════════════════════════════════════════
      let sdk;
      try {
        sdk = await import('../../../libs/sdk/dist/browser/browser.mjs');
      } catch (e) {
        const banner = document.getElementById('errorBanner');
        banner.style.display = 'block';
        banner.innerHTML = `
        <strong>Failed to load SDK bundle.</strong> Build it first:
        <code>npx nx build-browser-esm sdk</code>
      `;
        throw e;
      }

      const { create, Tool, Resource, ResourceTemplate, Prompt, ToolContext, ResourceContext, PromptContext } = sdk;

      const z = (await import('zod')).default ?? (await import('zod'));

      // ═══════════════════════════════════════════════════════════════════
      // MCP Entry Definitions
      // ═══════════════════════════════════════════════════════════════════

      // --- Tools ---

      class GreetTool extends ToolContext {
        async execute(input) {
          return `Hello, ${input.name}! Welcome to FrontMCP in the browser.`;
        }
      }
      Tool({
        name: 'greet',
        description: 'Greet a person by name',
        inputSchema: z.object({
          name: z.string().describe('Name of the person to greet'),
        }),
      })(GreetTool);

      class CalculateTool extends ToolContext {
        async execute(input) {
          const { operation, a, b } = input;
          let result;
          switch (operation) {
            case 'add':
              result = a + b;
              break;
            case 'subtract':
              result = a - b;
              break;
            case 'multiply':
              result = a * b;
              break;
            case 'divide':
              if (b === 0) throw new Error('Division by zero');
              result = a / b;
              break;
          }
          return `${a} ${operation} ${b} = ${result}`;
        }
      }
      Tool({
        name: 'calculate',
        description: 'Perform a math operation on two numbers',
        inputSchema: z.object({
          operation: z.enum(['add', 'subtract', 'multiply', 'divide']).describe('Math operation'),
          a: z.number().describe('First number'),
          b: z.number().describe('Second number'),
        }),
      })(CalculateTool);

      class RandomNumberTool extends ToolContext {
        async execute(input) {
          const { min, max } = input;
          if (min > max) throw new Error('min must be <= max');
          const result = Math.floor(Math.random() * (max - min + 1)) + min;
          return `Random number between ${min} and ${max}: ${result}`;
        }
      }
      Tool({
        name: 'random_number',
        description: 'Generate a random integer within a range',
        inputSchema: z.object({
          min: z.number().int().describe('Minimum value (inclusive)'),
          max: z.number().int().describe('Maximum value (inclusive)'),
        }),
      })(RandomNumberTool);

      // --- Resources ---

      class AppInfoResource extends ResourceContext {
        async execute(uri) {
          return {
            contents: [
              {
                uri,
                mimeType: 'application/json',
                text: JSON.stringify(
                  {
                    name: 'FrontMCP Browser Demo',
                    version: '1.0.0',
                    runtime: 'browser',
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString(),
                  },
                  null,
                  2,
                ),
              },
            ],
          };
        }
      }
      Resource({
        name: 'app-info',
        uri: 'app://info',
        description: 'Application metadata and runtime info',
        mimeType: 'application/json',
      })(AppInfoResource);

      // In-memory notes store
      const notesStore = {
        1: {
          id: '1',
          title: 'Getting Started',
          body: 'FrontMCP runs natively in the browser with in-memory transport.',
        },
        2: {
          id: '2',
          title: 'Architecture',
          body: 'The SDK uses decorators, DI, and flows to build MCP-compliant servers.',
        },
        3: {
          id: '3',
          title: 'Browser Support',
          body: 'Browser builds externalize zod and reflect-metadata via import maps.',
        },
      };

      class NoteResource extends ResourceContext {
        async execute(uri, params) {
          const note = notesStore[params.id];
          if (!note) {
            return {
              contents: [
                {
                  uri,
                  mimeType: 'application/json',
                  text: JSON.stringify({
                    error: `Note '${params.id}' not found. Available IDs: ${Object.keys(notesStore).join(', ')}`,
                  }),
                },
              ],
            };
          }
          return {
            contents: [
              {
                uri,
                mimeType: 'application/json',
                text: JSON.stringify(note, null, 2),
              },
            ],
          };
        }
      }
      ResourceTemplate({
        name: 'note',
        uriTemplate: 'notes://notes/{id}',
        description: 'Read a note by ID (available: 1, 2, 3)',
        mimeType: 'application/json',
      })(NoteResource);

      // --- Prompts ---

      class SummarizePrompt extends PromptContext {
        async execute(args) {
          return {
            messages: [
              {
                role: 'user',
                content: {
                  type: 'text',
                  text: `Please summarize the following text concisely:\n\n${args.text}`,
                },
              },
            ],
          };
        }
      }
      Prompt({
        name: 'summarize',
        description: 'Generate a summarization prompt for given text',
        arguments: [{ name: 'text', description: 'The text to summarize', required: true }],
      })(SummarizePrompt);

      class CodeReviewPrompt extends PromptContext {
        async execute(args) {
          return {
            messages: [
              {
                role: 'user',
                content: {
                  type: 'text',
                  text: `Please review the following ${args.language} code for best practices, bugs, and improvements:\n\n\`\`\`${args.language}\n${args.code}\n\`\`\``,
                },
              },
            ],
          };
        }
      }
      Prompt({
        name: 'code_review',
        description: 'Generate a code review prompt',
        arguments: [
          { name: 'language', description: 'Programming language', required: true },
          { name: 'code', description: 'Code to review', required: true },
        ],
      })(CodeReviewPrompt);

      // ═══════════════════════════════════════════════════════════════════
      // Application State
      // ═══════════════════════════════════════════════════════════════════

      const state = {
        server: null,
        client: null,
        status: 'idle', // idle | ready | connected | error
        activeTab: 'tools',
        tools: [],
        resources: [],
        resourceTemplates: [],
        prompts: [],
        selectedItem: null,
      };

      // ═══════════════════════════════════════════════════════════════════
      // DOM References
      // ═══════════════════════════════════════════════════════════════════

      const dom = {
        statusBadge: document.getElementById('statusBadge'),
        statusText: document.getElementById('statusText'),
        btnInit: document.getElementById('btnInit'),
        btnConnect: document.getElementById('btnConnect'),
        btnClear: document.getElementById('btnClear'),
        tabBar: document.getElementById('tabBar'),
        listPanel: document.getElementById('listPanel'),
        detailPanel: document.getElementById('detailPanel'),
        outputLog: document.getElementById('outputLog'),
        errorBanner: document.getElementById('errorBanner'),
      };

      // ═══════════════════════════════════════════════════════════════════
      // Status Management
      // ═══════════════════════════════════════════════════════════════════

      function setStatus(status, text) {
        state.status = status;
        dom.statusBadge.className = `status-badge ${status}`;
        dom.statusText.textContent = text || status;
      }

      // ═══════════════════════════════════════════════════════════════════
      // Output Log
      // ═══════════════════════════════════════════════════════════════════

      function appendLog(op, data, isError = false) {
        const entry = document.createElement('div');
        entry.className = `log-entry ${isError ? 'error' : 'success'}`;

        const time = new Date().toLocaleTimeString('en-US', { hour12: false, fractionalSecondDigits: 1 });
        let dataStr;
        if (typeof data === 'string') {
          dataStr = data;
        } else {
          try {
            dataStr = JSON.stringify(data, null, 2);
          } catch {
            dataStr = String(data);
          }
        }

        entry.innerHTML = `<span class="log-time">${time}</span><span class="log-op">${op}</span><span class="log-data">${escapeHtml(dataStr)}</span>`;
        dom.outputLog.appendChild(entry);
        dom.outputLog.scrollTop = dom.outputLog.scrollHeight;
      }

      function escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      // ═══════════════════════════════════════════════════════════════════
      // Initialize Server
      // ═══════════════════════════════════════════════════════════════════

      async function handleInitialize() {
        try {
          dom.btnInit.disabled = true;
          setStatus('ready', 'Initializing...');
          appendLog('init', 'Creating FrontMCP server...');

          state.server = await create({
            info: { name: 'browser-demo', version: '1.0.0' },
            tools: [GreetTool, CalculateTool, RandomNumberTool],
            resources: [AppInfoResource, NoteResource],
            prompts: [SummarizePrompt, CodeReviewPrompt],
            machineId: 'browser-demo-' + Date.now(),
          });

          setStatus('ready', 'Server ready');
          dom.btnConnect.disabled = false;
          appendLog('init', 'Server created successfully');
        } catch (err) {
          setStatus('error', 'Init failed');
          appendLog('init', err.message, true);
          dom.btnInit.disabled = false;
        }
      }

      // ═══════════════════════════════════════════════════════════════════
      // Connect Client
      // ═══════════════════════════════════════════════════════════════════

      async function handleConnect() {
        try {
          dom.btnConnect.disabled = true;
          appendLog('connect', 'Connecting MCP client...');

          state.client = await state.server.connect();

          // Fetch all lists
          const [toolsResult, resourcesResult, templatesResult, promptsResult] = await Promise.all([
            state.client.listTools(),
            state.client.listResources(),
            state.client.listResourceTemplates(),
            state.client.listPrompts(),
          ]);

          state.tools = toolsResult;
          state.resources = resourcesResult.resources || [];
          state.resourceTemplates = templatesResult.resourceTemplates || [];
          state.prompts = promptsResult.prompts || [];

          setStatus('connected', 'Connected');
          appendLog(
            'connect',
            `Connected! Tools: ${state.tools.length}, Resources: ${state.resources.length}, Templates: ${state.resourceTemplates.length}, Prompts: ${state.prompts.length}`,
          );

          renderList();
        } catch (err) {
          setStatus('error', 'Connect failed');
          appendLog('connect', err.message, true);
          dom.btnConnect.disabled = false;
        }
      }

      // ═══════════════════════════════════════════════════════════════════
      // List Rendering
      // ═══════════════════════════════════════════════════════════════════

      function renderList() {
        dom.listPanel.innerHTML = '';
        let items = [];

        if (state.activeTab === 'tools') {
          items = state.tools.map((t) => ({ id: t.name, name: t.name, type: 'tool', data: t }));
        } else if (state.activeTab === 'resources') {
          const res = state.resources.map((r) => ({ id: r.uri, name: r.name || r.uri, type: 'resource', data: r }));
          const tmpl = state.resourceTemplates.map((t) => ({
            id: t.uriTemplate,
            name: t.name || t.uriTemplate,
            type: 'template',
            data: t,
          }));
          items = [...res, ...tmpl];
        } else if (state.activeTab === 'prompts') {
          items = state.prompts.map((p) => ({ id: p.name, name: p.name, type: 'prompt', data: p }));
        }

        if (items.length === 0) {
          dom.listPanel.innerHTML = '<div class="list-empty">No items. Connect client first.</div>';
          return;
        }

        for (const item of items) {
          const el = document.createElement('div');
          el.className = 'list-item' + (state.selectedItem?.id === item.id ? ' active' : '');
          el.innerHTML = `<div>${escapeHtml(item.name)}</div><div class="item-type">${item.type}</div>`;
          el.addEventListener('click', () => {
            state.selectedItem = item;
            renderList();
            renderDetail(item);
          });
          dom.listPanel.appendChild(el);
        }
      }

      // ═══════════════════════════════════════════════════════════════════
      // Detail / Form Rendering
      // ═══════════════════════════════════════════════════════════════════

      function renderDetail(item) {
        if (item.type === 'tool') renderToolForm(item.data);
        else if (item.type === 'resource') renderResourceForm(item.data);
        else if (item.type === 'template') renderTemplateForm(item.data);
        else if (item.type === 'prompt') renderPromptForm(item.data);
      }

      function renderToolForm(tool) {
        const schema = tool.inputSchema;
        const properties = schema?.properties || {};
        const required = schema?.required || [];

        let html = `<h3>${escapeHtml(tool.name)}</h3>`;
        if (tool.description) html += `<div class="description">${escapeHtml(tool.description)}</div>`;
        html += '<form id="toolForm">';

        for (const [key, prop] of Object.entries(properties)) {
          const isRequired = required.includes(key);
          html += `<div class="form-group">`;
          html += `<label>${escapeHtml(key)}${isRequired ? ' *' : ''} <span class="field-type">${getFieldType(prop)}</span></label>`;

          if (prop.enum) {
            html += `<select name="${escapeHtml(key)}">`;
            for (const val of prop.enum) {
              html += `<option value="${escapeHtml(String(val))}">${escapeHtml(String(val))}</option>`;
            }
            html += `</select>`;
          } else if (prop.type === 'number' || prop.type === 'integer') {
            html += `<input type="number" name="${escapeHtml(key)}" step="${prop.type === 'integer' ? '1' : 'any'}" placeholder="${escapeHtml(prop.description || '')}" ${isRequired ? 'required' : ''}>`;
          } else {
            html += `<input type="text" name="${escapeHtml(key)}" placeholder="${escapeHtml(prop.description || '')}" ${isRequired ? 'required' : ''}>`;
          }
          html += `</div>`;
        }

        html += '<button type="submit" class="primary">Call Tool</button>';
        html += '</form>';
        dom.detailPanel.innerHTML = html;

        document.getElementById('toolForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const args = {};
          for (const [key, prop] of Object.entries(properties)) {
            const raw = formData.get(key);
            if (prop.type === 'number' || prop.type === 'integer') {
              args[key] = Number(raw);
            } else {
              args[key] = raw;
            }
          }

          appendLog(`callTool('${tool.name}')`, JSON.stringify(args));
          try {
            const result = await state.client.callTool(tool.name, args);
            appendLog(`result`, result);
          } catch (err) {
            appendLog(`error`, err.message, true);
          }
        });
      }

      function renderResourceForm(resource) {
        let html = `<h3>${escapeHtml(resource.name || resource.uri)}</h3>`;
        if (resource.description) html += `<div class="description">${escapeHtml(resource.description)}</div>`;
        html += `<div class="form-group"><label>URI</label><input type="text" value="${escapeHtml(resource.uri)}" readonly></div>`;
        if (resource.mimeType)
          html += `<div class="form-group"><label>MIME Type</label><input type="text" value="${escapeHtml(resource.mimeType)}" readonly></div>`;
        html += `<button id="btnReadResource" class="primary">Read Resource</button>`;
        dom.detailPanel.innerHTML = html;

        document.getElementById('btnReadResource').addEventListener('click', async () => {
          appendLog(`readResource('${resource.uri}')`, '');
          try {
            const result = await state.client.readResource(resource.uri);
            appendLog('result', result);
          } catch (err) {
            appendLog('error', err.message, true);
          }
        });
      }

      function renderTemplateForm(template) {
        // Extract param names from URI template
        const paramNames = [];
        const re = /\{([^}]+)\}/g;
        let match;
        while ((match = re.exec(template.uriTemplate)) !== null) {
          paramNames.push(match[1]);
        }

        let html = `<h3>${escapeHtml(template.name || template.uriTemplate)}</h3>`;
        if (template.description) html += `<div class="description">${escapeHtml(template.description)}</div>`;
        html += `<div class="form-group"><label>URI Template</label><input type="text" value="${escapeHtml(template.uriTemplate)}" readonly></div>`;
        html += '<form id="templateForm">';
        for (const param of paramNames) {
          html += `<div class="form-group"><label>${escapeHtml(param)}</label><input type="text" name="${escapeHtml(param)}" placeholder="Enter ${escapeHtml(param)}" required></div>`;
        }
        html += '<button type="submit" class="primary">Read Resource</button>';
        html += '</form>';
        dom.detailPanel.innerHTML = html;

        document.getElementById('templateForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          let uri = template.uriTemplate;
          for (const param of paramNames) {
            uri = uri.replace(`{${param}}`, encodeURIComponent(formData.get(param)));
          }

          appendLog(`readResource('${uri}')`, '');
          try {
            const result = await state.client.readResource(uri);
            appendLog('result', result);
          } catch (err) {
            appendLog('error', err.message, true);
          }
        });
      }

      function renderPromptForm(prompt) {
        const args = prompt.arguments || [];

        let html = `<h3>${escapeHtml(prompt.name)}</h3>`;
        if (prompt.description) html += `<div class="description">${escapeHtml(prompt.description)}</div>`;
        html += '<form id="promptForm">';

        for (const arg of args) {
          html += `<div class="form-group">`;
          html += `<label>${escapeHtml(arg.name)}${arg.required ? ' *' : ''}</label>`;
          // Use textarea for args likely to contain long text
          if (arg.name === 'text' || arg.name === 'code' || arg.name === 'content') {
            html += `<textarea name="${escapeHtml(arg.name)}" placeholder="${escapeHtml(arg.description || '')}" ${arg.required ? 'required' : ''}></textarea>`;
          } else {
            html += `<input type="text" name="${escapeHtml(arg.name)}" placeholder="${escapeHtml(arg.description || '')}" ${arg.required ? 'required' : ''}>`;
          }
          html += `</div>`;
        }

        html += '<button type="submit" class="primary">Get Prompt</button>';
        html += '</form>';
        dom.detailPanel.innerHTML = html;

        document.getElementById('promptForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const promptArgs = {};
          for (const arg of args) {
            promptArgs[arg.name] = formData.get(arg.name) || '';
          }

          appendLog(`getPrompt('${prompt.name}')`, JSON.stringify(promptArgs));
          try {
            const result = await state.client.getPrompt(prompt.name, promptArgs);
            appendLog('result', result);
          } catch (err) {
            appendLog('error', err.message, true);
          }
        });
      }

      function getFieldType(prop) {
        if (prop.enum) return `enum[${prop.enum.join('|')}]`;
        return prop.type || 'string';
      }

      // ═══════════════════════════════════════════════════════════════════
      // Event Handlers
      // ═══════════════════════════════════════════════════════════════════

      dom.btnInit.addEventListener('click', handleInitialize);
      dom.btnConnect.addEventListener('click', handleConnect);
      dom.btnClear.addEventListener('click', () => {
        dom.outputLog.innerHTML = '';
      });

      // Tab switching
      dom.tabBar.addEventListener('click', (e) => {
        if (!e.target.classList.contains('tab')) return;
        const tab = e.target.dataset.tab;
        state.activeTab = tab;
        state.selectedItem = null;
        dom.tabBar.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
        e.target.classList.add('active');
        renderList();
        dom.detailPanel.innerHTML = '<div class="placeholder">Select an item from the list</div>';
      });

      // ═══════════════════════════════════════════════════════════════════
      // Error Handling
      // ═══════════════════════════════════════════════════════════════════

      window.onerror = (msg) => {
        appendLog('uncaught', msg, true);
        setStatus('error', 'Error');
      };
      window.onunhandledrejection = (e) => {
        appendLog('uncaught', e.reason?.message || String(e.reason), true);
        setStatus('error', 'Error');
      };
    </script>

    <noscript>
      <p style="padding: 2rem; color: #e0e0e0">JavaScript is required for this demo.</p>
    </noscript>
  </body>
</html>
